<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent vs Buy Simulator (Historical, Deterministic)</title>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-blue: #0071e3;
            --accent-green: #34c759;
            --accent-orange: #ff9500;
            --border-color: #d2d2d7;
            --input-bg: #f5f5f7;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.04);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        h1 {
            font-size: 40px;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 17px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .disclaimer {
            font-size: 13px;
            color: var(--text-secondary);
            background: #e8e8ed;
            padding: 12px;
            border-radius: 8px;
            display: inline-block;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Controls Panel */
        .panel {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.02);
        }

        .panel-title {
            font-size: 19px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            background: var(--input-bg);
            transition: all 0.2s;
            box-sizing: border-box; /* Fix width issue */
            font-family: var(--font-family);
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        .input-row {
            display: flex;
            gap: 10px;
        }
        
        .input-row .form-group {
            flex: 1;
        }

        button.run-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-top: 10px;
        }

        button.run-btn:hover {
            background-color: #0062c4;
        }

        button.run-btn:active {
            transform: scale(0.98);
        }

        /* Results Area */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .scoreboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .score-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .score-card.buyer { border-top: 4px solid var(--accent-blue); }
        .score-card.renter { border-top: 4px solid var(--accent-orange); }

        .score-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .score-value {
            font-size: 28px;
            font-weight: 700;
            margin: 8px 0;
            letter-spacing: -0.03em;
        }

        .score-diff {
            font-size: 12px;
            font-weight: 500;
        }

        .positive { color: var(--accent-green); }
        .negative { color: #ff3b30; }

        .winner-banner {
            background: var(--text-primary);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            display: none; /* Hidden by default until run */
        }

        /* Chart */
        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 18px;
            box-shadow: var(--shadow-md);
            height: 400px;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Utility */
        .hidden { display: none; }
        .loading { opacity: 0.5; pointer-events: none; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Rent vs Buy Simulator</h1>
        <div class="subtitle">Historical, Deterministic Counterfactual Analysis</div>
        <div class="disclaimer">
            This tool compares the wealth outcomes of two identical individuals, differing only in housing choice. 
            It is educational, not predictive. Results are derived entirely from provided historical data.
        </div>
    </header>

    <div class="main-grid">
        <!-- INPUTS -->
        <aside class="panel">
            <h2 class="panel-title">Parameters</h2>
            
            <div class="form-group">
                <label>Starting Annual Income</label>
                <input type="number" id="income" value="50000">
            </div>

            <div class="form-group">
                <label>Initial Savings</label>
                <input type="number" id="savings" value="20000">
            </div>

            <div class="form-group">
                <label>Base Property Price (Year 1)</label>
                <input type="number" id="housePrice" value="150000">
            </div>

            <div class="form-group">
                <label>Base Annual Rent (Year 1)</label>
                <input type="number" id="baseRent" value="12000">
            </div>

            <div class="input-row">
                <div class="form-group">
                    <label>Deposit %</label>
                    <select id="deposit">
                        <option value="0.05">5%</option>
                        <option value="0.10">10%</option>
                        <option value="0.15">15%</option>
                        <option value="0.20" selected>20%</option>
                        <option value="0.25">25%</option>
                        <option value="0.30">30%</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mortgage Term</label>
                    <input type="number" id="term" value="25">
                </div>
            </div>

            <div class="form-group">
                <label>Number of Moves (Total)</label>
                <input type="number" id="moves" value="0" min="0" max="10">
                <div style="font-size: 11px; color: #86868b; margin-top:4px;">Moves are evenly spaced.</div>
            </div>

            <button class="run-btn" id="runBtn">Run Simulation</button>
        </aside>

        <!-- RESULTS -->
        <div class="results-container">
            
            <div id="winnerBanner" class="winner-banner">
                Winner: <span id="winnerText">-</span>
            </div>

            <div class="scoreboard">
                <div class="score-card buyer">
                    <div class="score-label">Buyer Net Worth</div>
                    <div class="score-value" id="buyerWealth">0</div>
                    <div class="score-diff" id="buyerDiff"></div>
                </div>
                <div class="score-card renter">
                    <div class="score-label">Renter Net Worth</div>
                    <div class="score-value" id="renterWealth">0</div>
                    <div class="score-diff" id="renterDiff"></div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="wealthChart"></canvas>
                <div class="legend">
                    <div class="legend-item"><div class="dot" style="background:var(--accent-blue)"></div> Buyer</div>
                    <div class="legend-item"><div class="dot" style="background:var(--accent-orange)"></div> Renter</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
/**
 * DEFAULT DATA
 * Provided in prompt. 
 * Note: The CSV data block has 13 columns. The header string provided in prompt has 12.
 * The Prompt text lists: renter_move_cost_percent_of_annual_rent, capital_gains_tax_percent.
 * We map strictly based on the expected columns from the prompt's "INPUT DATA (REQUIRED)" list.
 * We assume the 13th column in the raw data rows is CGT, and we force it to 0 per instructions.
 */
const CSV_DATA = `year,inflation_rate_percent,house_price_index,rent_price_index,mortgage_interest_rate_percent,annual_return_percent,income_growth_rate_percent,purchase_cost_percent,sale_cost_percent,property_tax_percent,maintenance_percent,renter_move_cost_percent_of_annual_rent,capital_gains_tax_percent
1996,2.6,100.0,100.0,6.9,16.0,5.2,3.5,2.5,1.2,1.0,12.5,24.0
1997,2.4,108.5,103.8,7.5,24.7,5.8,3.5,2.5,1.2,1.0,12.5,24.0
1998,1.8,116.2,107.2,7.8,17.8,5.4,3.5,2.5,1.2,1.0,12.5,24.0
1999,1.6,125.4,110.5,6.5,21.1,5.1,3.5,2.5,1.2,1.0,12.5,24.0
2000,0.8,135.1,113.9,6.2,-7.5,4.9,3.5,2.5,1.1,1.0,12.5,24.0
2001,1.2,147.3,117.8,5.6,-13.3,5.3,3.5,2.5,1.1,1.0,12.5,24.0
2002,1.3,163.8,122.3,5.0,-22.7,4.7,3.5,2.5,1.1,1.0,12.5,24.0
2003,1.4,185.6,127.4,4.7,17.9,4.2,3.5,2.5,1.0,1.0,12.5,24.0
2004,1.3,205.9,132.9,5.1,12.8,4.5,3.5,2.5,1.0,1.0,12.5,24.0
2005,2.1,218.7,138.5,5.0,20.9,4.8,3.5,2.5,1.0,1.0,12.5,24.0
2006,2.3,230.4,144.2,5.4,16.8,4.6,3.5,2.5,1.0,1.0,12.5,24.0
2007,2.3,245.1,150.1,6.1,7.4,4.1,3.5,2.5,0.9,1.0,12.5,24.0
2008,3.6,238.6,155.3,6.3,-29.1,3.2,3.5,2.5,0.9,1.0,12.5,18.0
2009,2.2,220.3,158.9,4.2,27.3,-1.5,3.5,2.5,0.9,1.0,12.5,18.0
2010,3.3,228.9,162.7,3.8,12.6,2.1,3.5,2.5,0.9,1.0,12.5,18.0
2011,4.5,230.2,167.4,3.9,-2.2,1.8,3.5,2.5,0.9,1.0,12.5,18.0
2012,2.8,231.5,172.0,4.0,10.5,1.4,3.5,2.5,0.9,1.0,12.5,18.0
2013,2.6,240.8,176.3,3.6,13.0,1.9,3.5,2.5,0.9,1.0,12.5,18.0
2014,1.5,255.6,180.8,3.3,1.2,1.2,4.0,2.5,0.9,1.0,12.5,18.0
2015,0.0,270.1,185.6,3.1,0.9,2.0,4.0,2.5,0.8,1.0,12.5,18.0
2016,0.7,285.4,190.9,3.0,16.5,2.5,4.5,2.5,0.8,1.0,12.5,10.0
2017,2.7,300.2,197.2,3.2,13.1,2.6,4.5,2.5,0.8,1.0,12.5,10.0
2018,2.5,310.7,204.1,3.4,-9.5,3.1,4.5,2.5,0.8,1.0,12.5,10.0
2019,1.8,318.9,211.0,3.3,19.1,3.4,4.5,2.5,0.8,1.0,12.5,10.0
2020,0.9,330.5,216.5,3.1,-9.8,1.8,4.5,2.5,0.8,1.0,12.5,10.0
2021,2.6,360.2,223.8,2.8,18.4,4.0,4.5,2.5,0.7,1.0,12.5,10.0
2022,9.1,385.4,238.5,4.5,-0.9,5.5,4.5,2.5,0.7,1.0,12.5,10.0
2023,7.3,395.1,258.4,6.2,7.9,6.2,4.5,2.5,0.7,1.0,12.5,10.0
2024,2.5,405.8,278.5,5.8,8.7,6.9,4.5,2.5,0.6,1.0,12.5,10.0
2025,3.2,415.0,295.0,5.0,21.6,5.3,4.5,2.5,0.6,1.0,12.5,18.0`;

/**
 * UTILITIES
 */
const formatCurrency = (val) => {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
    }).format(val).replace('$', ''); // Currency agnostic per requirements, though we use formatting for grouping
};

const parseCSV = (csvText) => {
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const data = [];

    for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',').map(item => parseFloat(item.trim()));
        const entry = {};
        headers.forEach((header, index) => {
            // Handle potential missing data or extra columns by checking length
            if (index < row.length) {
                entry[header] = row[index];
            }
        });
        // Ensure CGT exists for logic (Prompt says it's always 0, CSV has data)
        if (!entry['capital_gains_tax_percent']) {
            entry['capital_gains_tax_percent'] = 0;
        }
        data.push(entry);
    }
    return data;
};

/**
 * SIMULATION LOGIC
 */
class Simulator {
    constructor(data, params) {
        this.history = data;
        this.params = params;
        this.years = data.map(d => d.year);
        
        // Calculate Move Years
        // "Moves are evenly spaced through the simulation period"
        this.moveYears = [];
        if (params.moves > 0) {
            const totalYears = this.years.length;
            const interval = totalYears / (params.moves + 1);
            for (let m = 1; m <= params.moves; m++) {
                // Index in 0..totalYears-1
                const idx = Math.floor(m * interval);
                this.moveYears.push(this.years[idx]);
            }
        }
    }

    run() {
        // Initialize States
        let buyer = {
            cash: this.params.initialSavings,
            propertyValue: 0,
            mortgageBalance: 0,
            mortgageTermRemaining: 0,
            ownsHome: false,
            wealthHistory: []
        };

        let renter = {
            investmentValue: this.params.initialSavings,
            wealthHistory: []
        };

        let currentIncome = this.params.startingIncome;

        // Yearly Loop
        this.history.forEach((row, index) => {
            const year = row.year;
            const isMoveYear = this.moveYears.includes(year);

            // --- INCOME LOGIC (SHARED) ---
            // Income grows exogenously
            if (index > 0) {
                const growthRate = this.history[index-1].income_growth_rate_percent / 100;
                currentIncome = currentIncome * (1 + growthRate);
            }

            // --- RENTER LOGIC ---
            // 1. Pay Rent
            const annualRent = this.params.baseRent * (row.rent_price_index / 100);
            let renterNetCash = currentIncome - annualRent;

            // 2. Move Cost
            if (isMoveYear) {
                const moveCostPct = row.renter_move_cost_percent_of_annual_rent / 100;
                const moveCost = annualRent * moveCostPct;
                renterNetCash -= moveCost;
            }

            // 3. Invest Surplus
            // "Any money not spent on rent is automatically invested"
            // "Returns are applied yearly"
            // Apply return to existing balance first
            const investmentReturn = row.annual_return_percent / 100;
            renter.investmentValue = renter.investmentValue * (1 + investmentReturn);
            // Then add contribution
            renter.investmentValue += renterNetCash;

            // Renter Net Worth (Liquidation value)
            // "Capital gains tax is applied once at liquidation"
            // Note: We calculate net worth as if liquidated at the end of this year for the chart
            // But strictly, tax is at the END of simulation.
            // For the trajectory, we track gross value, apply tax at final step for comparison.
            renter.wealthHistory.push({
                year: year,
                grossWealth: renter.investmentValue
            });


            // --- BUYER LOGIC ---
            
            // Purchase Check
            if (!buyer.ownsHome) {
                const propertyPrice = this.params.baseHousePrice * (row.house_price_index / 100);
                const depositNeeded = propertyPrice * this.params.depositPct;
                const purchaseCost = propertyPrice * (row.purchase_cost_percent / 100);
                const totalCashNeeded = depositNeeded + purchaseCost;

                if (buyer.cash >= totalCashNeeded) {
                    // BUY
                    buyer.ownsHome = true;
                    buyer.propertyValue = propertyPrice;
                    buyer.mortgageBalance = propertyPrice - depositNeeded;
                    buyer.mortgageTermRemaining = this.params.mortgageTerm; // Resets on every move/new purchase
                    buyer.cash -= totalCashNeeded;
                } else {
                    // Cannot buy yet (Waiting period)
                }
            }

            if (buyer.ownsHome) {
                // Update Property Value based on Index
                // Assumption: 'Base House Price' is the index anchor, but they bought a specific house.
                // If they bought at index 100 for 150k. Index is now 200.
                // Current Value = PurchasePrice * (CurrentIndex / PurchaseIndex).
                // We need to store the purchase index?
                // Simplification based on "Base property price (in year 1 units)":
                // The prompt implies we track the value of the "Standard Home".
                buyer.propertyValue = this.params.baseHousePrice * (row.house_price_index / 100);

                // 1. Mortgage Payment
                // Variable rate: "Interest rate each year = mortgage_interest_rate_percent"
                const interestRate = row.mortgage_interest_rate_percent / 100;
                const interestPayment = buyer.mortgageBalance * interestRate;
                // "Principal = mortgage_balance / remaining_term"
                // Note: This is linear principal repayment (equal principal), not annuity.
                const principalPayment = buyer.mortgageBalance / buyer.mortgageTermRemaining;
                
                const totalMortgagePayment = interestPayment + principalPayment;

                // 2. Ongoing Costs
                const propertyTax = buyer.propertyValue * (row.property_tax_percent / 100);
                const maintenance = buyer.propertyValue * (row.maintenance_percent / 100);

                const totalHousingCost = totalMortgagePayment + propertyTax + maintenance;

                // 3. Cash Flow
                buyer.cash += currentIncome; // Income comes in
                buyer.cash -= totalHousingCost; // Costs go out

                // Update Mortgage
                buyer.mortgageBalance -= principalPayment;
                buyer.mortgageTermRemaining--;

                // 4. Move Logic (Sell)
                if (isMoveYear) {
                    const salePrice = buyer.propertyValue;
                    const saleCost = salePrice * (row.sale_cost_percent / 100);
                    
                    // Settle Mortgage
                    const netEquity = salePrice - saleCost - buyer.mortgageBalance;
                    
                    // Add equity to cash
                    buyer.cash += netEquity;

                    // Reset ownership state
                    buyer.ownsHome = false;
                    buyer.propertyValue = 0;
                    buyer.mortgageBalance = 0;

                    // IMMEDIATE RE-PURCHASE (Same Year Logic, if possible)
                    // "On a move... Buyer purchases a new property..."
                    // We run the purchase logic again for this year
                    const newPropertyPrice = this.params.baseHousePrice * (row.house_price_index / 100);
                    const newDepositNeeded = newPropertyPrice * this.params.depositPct;
                    const newPurchaseCost = newPropertyPrice * (row.purchase_cost_percent / 100);
                    const newTotalNeeded = newDepositNeeded + newPurchaseCost;

                    if (buyer.cash >= newTotalNeeded) {
                        buyer.ownsHome = true;
                        buyer.propertyValue = newPropertyPrice;
                        buyer.mortgageBalance = newPropertyPrice - newDepositNeeded;
                        buyer.mortgageTermRemaining = this.params.mortgageTerm; // Resets
                        buyer.cash -= newTotalNeeded;
                    } else {
                        // Failed to buy back immediately? 
                        // "Deterministic" and "Identical Humans" usually implies they stay in the market.
                        // We'll leave them as renters for the remainder or until they can afford.
                        // Given they just sold, they almost certainly can afford unless crash > 100%.
                    }
                }
            } else {
                // Not owning, just accumulating cash (which is not invested)
                buyer.cash += currentIncome;
            }

            // Calculate Buyer Net Worth
            // "Final net worth... cash_savings + (property_value - mortgage_balance)"
            const buyerNetWorth = buyer.cash + (buyer.propertyValue - buyer.mortgageBalance);
            buyer.wealthHistory.push({
                year: year,
                wealth: buyerNetWorth
            });
        });

        // Final Liquidation Logic for Renter (Tax)
        const finalYearData = this.history[this.history.length - 1];
        // Prompt says: "capital_gains_tax_percent is always 0" (NB in prompt).
        // Even if data has it, we obey the constraint.
        // If we were to use the data: finalYearData.capital_gains_tax_percent
        const cgtRate = 0; 
        const finalRenterWealth = renter.investmentValue * (1 - cgtRate);

        return {
            buyer: {
                finalWealth: buyer.wealthHistory[buyer.wealthHistory.length - 1].wealth,
                history: buyer.wealthHistory
            },
            renter: {
                finalWealth: finalRenterWealth,
                history: renter.wealthHistory.map(h => ({...h, wealth: h.grossWealth})) // unify structure
            }
        };
    }
}

/**
 * CHART RENDERER (Vanilla Canvas)
 */
class ChartRenderer {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.padding = { top: 20, right: 20, bottom: 30, left: 50 };
    }

    resize() {
        // Handle high DPI
        const parent = this.canvas.parentElement;
        const dpr = window.devicePixelRatio || 1;
        const rect = parent.getBoundingClientRect();
        
        this.canvas.width = rect.width * dpr;
        this.canvas.height = rect.height * dpr;
        
        this.ctx.scale(dpr, dpr);
        this.width = rect.width;
        this.height = rect.height;
    }

    draw(simulationResult) {
        this.resize();
        const { ctx, width, height, padding } = this;
        const buyerData = simulationResult.buyer.history;
        const renterData = simulationResult.renter.history;
        
        // Clear
        ctx.clearRect(0, 0, width, height);
        
        // Determine scales
        const allValues = [
            ...buyerData.map(d => d.wealth),
            ...renterData.map(d => d.wealth)
        ];
        
        let minVal = Math.min(...allValues);
        let maxVal = Math.max(...allValues);
        
        // Add padding to range
        const range = maxVal - minVal;
        if (range === 0) {
            minVal -= 1000;
            maxVal += 1000;
        } else {
            minVal -= range * 0.1;
            maxVal += range * 0.1;
        }

        // If values are negative, ensure we handle crossing zero
        const xScale = (width - padding.left - padding.right) / (buyerData.length - 1);
        const yScale = (height - padding.top - padding.bottom) / (maxVal - minVal);
        
        const getX = (i) => padding.left + i * xScale;
        const getY = (val) => height - padding.bottom - (val - minVal) * yScale;

        // Draw Grid (Horizontal)
        ctx.beginPath();
        ctx.strokeStyle = '#e5e5ea';
        ctx.lineWidth = 1;
        ctx.font = '10px sans-serif';
        ctx.fillStyle = '#86868b';
        ctx.textAlign = 'right';

        const gridSteps = 5;
        for(let i=0; i<=gridSteps; i++) {
            const val = minVal + (i/gridSteps) * (maxVal - minVal);
            const y = getY(val);
            
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.fillText(Math.round(val/1000) + 'k', padding.left - 5, y + 3);
        }
        ctx.stroke();

        // Draw X Axis Labels (Years) - First, Middle, Last
        ctx.textAlign = 'center';
        const yearIndices = [0, Math.floor(buyerData.length/2), buyerData.length-1];
        yearIndices.forEach(i => {
            const x = getX(i);
            const year = buyerData[i].year;
            ctx.fillText(year, x, height - 5);
        });

        // Helper to draw line
        const drawLine = (data, color) => {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            
            data.forEach((d, i) => {
                const x = getX(i);
                const y = getY(d.wealth);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        };

        // Draw Buyer
        drawLine(buyerData, '#0071e3');
        
        // Draw Renter
        drawLine(renterData, '#ff9500');
    }
}

/**
 * MAIN APP CONTROLLER
 */
const App = {
    data: null,
    chart: null,

    init() {
        this.data = parseCSV(CSV_DATA);
        this.chart = new ChartRenderer('wealthChart');

        document.getElementById('runBtn').addEventListener('click', () => {
            this.runSimulation();
        });

        // Run on load with defaults
        this.runSimulation();
        
        // Handle resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => this.chart.draw(this.lastResult), 100);
        });
    },

    getInputs() {
        return {
            startingIncome: parseFloat(document.getElementById('income').value),
            initialSavings: parseFloat(document.getElementById('savings').value),
            baseHousePrice: parseFloat(document.getElementById('housePrice').value),
            baseRent: parseFloat(document.getElementById('baseRent').value),
            depositPct: parseFloat(document.getElementById('deposit').value),
            mortgageTerm: parseInt(document.getElementById('term').value),
            moves: parseInt(document.getElementById('moves').value)
        };
    },

    runSimulation() {
        const params = this.getInputs();
        const sim = new Simulator(this.data, params);
        const result = sim.run();
        this.lastResult = result;

        this.updateUI(result);
    },

    updateUI(result) {
        // Update Scoreboard
        const bVal = result.buyer.finalWealth;
        const rVal = result.renter.finalWealth;
        
        const bEl = document.getElementById('buyerWealth');
        const rEl = document.getElementById('renterWealth');
        
        bEl.textContent = formatCurrency(bVal);
        rEl.textContent = formatCurrency(rVal);

        // Differences
        const bDiffEl = document.getElementById('buyerDiff');
        const rDiffEl = document.getElementById('renterDiff');
        
        const diff = bVal - rVal;
        const diffStr = formatCurrency(Math.abs(diff));
        
        if (diff > 0) {
            bDiffEl.textContent = `+${diffStr} vs Renter`;
            bDiffEl.className = 'score-diff positive';
            rDiffEl.textContent = `-${diffStr} vs Buyer`;
            rDiffEl.className = 'score-diff negative';
        } else if (diff < 0) {
            bDiffEl.textContent = `-${diffStr} vs Renter`;
            bDiffEl.className = 'score-diff negative';
            rDiffEl.textContent = `+${diffStr} vs Buyer`;
            rDiffEl.className = 'score-diff positive';
        } else {
            bDiffEl.textContent = 'Tie';
            rDiffEl.textContent = 'Tie';
        }

        // Winner Banner
        const banner = document.getElementById('winnerBanner');
        const wText = document.getElementById('winnerText');
        
        banner.style.display = 'block';
        if (diff > 0) {
            banner.style.backgroundColor = '#0071e3';
            wText.textContent = `Buyer wins by ${diffStr}`;
        } else if (diff < 0) {
            banner.style.backgroundColor = '#ff9500'; // Use renter color or generic
            banner.style.color = '#fff'; // ensure contrast
            wText.textContent = `Renter wins by ${diffStr}`;
        } else {
            banner.style.backgroundColor = '#86868b';
            wText.textContent = 'It is a Tie';
        }

        // Draw Chart
        this.chart.draw(result);
    }
};

// Start
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});

</script>
</body>
</html>