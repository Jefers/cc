<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent vs Buy Simulator (Live Historical Replay)</title>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-blue: #0071e3;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --accent-orange: #ff9500;
            --border-color: #d2d2d7;
            --input-bg: #f5f5f7;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.04);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 32px;
            font-weight: 600;
            margin: 0 0 10px 0;
        }
        .subtitle {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* INPUTS SECTION */
        .controls-wrapper {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--input-bg);
            box-sizing: border-box;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        button {
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #0062c4; }
        .btn-secondary { background: #e8e8ed; color: var(--text-primary); }
        .btn-secondary:hover { background: #d2d2d7; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }

        /* STATUS BAR */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .year-indicator {
            font-size: 24px;
            color: var(--text-primary);
        }

        .leader-indicator {
            font-size: 18px;
            padding: 6px 16px;
            border-radius: 20px;
            background: #e8e8ed;
            color: var(--text-secondary);
            transition: all 0.5s ease;
        }
        .leader-buyer { background: var(--accent-blue); color: white; }
        .leader-renter { background: var(--accent-orange); color: white; }
        .leader-tie { background: var(--text-secondary); color: white; }

        /* DASHBOARD CARDS */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .card.buyer { border-top: 4px solid var(--accent-blue); }
        .card.renter { border-top: 4px solid var(--accent-orange); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title { font-size: 18px; font-weight: 700; }
        .net-worth-display {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .stat-label { color: var(--text-secondary); }
        .stat-value { font-weight: 500; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums;}
        
        .positive-change { color: var(--accent-green); }
        .negative-change { color: var(--accent-red); }

        .badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            background: #eee;
            display: inline-block;
            margin-top: 10px;
        }

        /* CHART */
        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            height: 300px;
            position: relative;
        }
        
        canvas { width: 100%; height: 100%; }

        .event-flash {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 10;
        }
        .event-flash.visible { opacity: 1; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Rent vs Buy Simulator</h1>
        <div class="subtitle">Historical, Deterministic Year-by-Year Replay</div>
    </header>

    <!-- INPUTS -->
    <div class="controls-wrapper">
        <div class="input-grid">
            <div class="form-group">
                <label>Starting Annual Income</label>
                <input type="number" id="income" value="50000">
            </div>
            <div class="form-group">
                <label>Initial Savings</label>
                <input type="number" id="savings" value="20000">
            </div>
            <div class="form-group">
                <label>Base House Price (Year 1)</label>
                <input type="number" id="housePrice" value="150000">
            </div>
            <div class="form-group">
                <label>Base Annual Rent (Year 1)</label>
                <input type="number" id="baseRent" value="12000">
            </div>
            <div class="form-group">
                <label>Deposit %</label>
                <select id="deposit">
                    <option value="0.05">5%</option>
                    <option value="0.10">10%</option>
                    <option value="0.15">15%</option>
                    <option value="0.20" selected>20%</option>
                    <option value="0.25">25%</option>
                </select>
            </div>
            <div class="form-group">
                <label>Mortgage Term (Years)</label>
                <input type="number" id="term" value="25">
            </div>
            <div class="form-group">
                <label>Total Moves</label>
                <input type="number" id="moves" value="1" min="0" max="10">
            </div>
        </div>
        <div class="action-bar">
            <button class="btn-primary" id="resetBtn">Reset & Calculate</button>
            <button class="btn-secondary" id="playBtn" disabled>Play Simulation</button>
        </div>
    </div>

    <!-- SIMULATION VIEW -->
    <div class="status-bar">
        <div class="year-indicator">Year <span id="displayYear">-</span></div>
        <div class="leader-indicator" id="leaderBadge">Waiting to start...</div>
    </div>

    <div class="dashboard-grid">
        <!-- BUYER CARD -->
        <div class="card buyer">
            <div class="card-header">
                <div class="card-title">Buyer</div>
                <div class="net-worth-display" id="buyerNetWorth">0</div>
            </div>
            
            <div class="stat-row">
                <span class="stat-label">Annual Income</span>
                <span class="stat-value" id="buyerIncome">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">House Value</span>
                <span class="stat-value" id="buyerHouseVal">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Mortgage Balance</span>
                <span class="stat-value" id="buyerMortgage">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Cash Savings</span>
                <span class="stat-value" id="buyerCash">0</span>
            </div>
            <div class="stat-row" style="border-bottom:none; padding-top:12px; font-size:12px; color:#888;">
                <span class="stat-label">Housing Cost (Est. Annual)</span>
                <span class="stat-value" id="buyerCost">0</span>
            </div>
            <div id="buyerStatusBadge" class="badge">Renting</div>
        </div>

        <!-- RENTER CARD -->
        <div class="card renter">
            <div class="card-header">
                <div class="card-title">Renter</div>
                <div class="net-worth-display" id="renterNetWorth">0</div>
            </div>
            
            <div class="stat-row">
                <span class="stat-label">Annual Income</span>
                <span class="stat-value" id="renterIncome">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Annual Rent</span>
                <span class="stat-value" id="renterRent">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Investment Value</span>
                <span class="stat-value" id="renterInvest">0</span>
            </div>
             <div class="stat-row" style="border-bottom:none; padding-top:12px; font-size:12px; color:#888;">
                <span class="stat-label">Investment Return (Prev Year)</span>
                <span class="stat-value" id="renterReturn">-</span>
            </div>
            <div id="renterStatusBadge" class="badge">Investing Surplus</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="event-flash" id="eventFlash">Market Event</div>
        <canvas id="wealthChart"></canvas>
    </div>
</div>

<script>
/**
 * DATA
 */
const CSV_DATA = `year,inflation_rate_percent,house_price_index,rent_price_index,mortgage_interest_rate_percent,annual_return_percent,income_growth_rate_percent,purchase_cost_percent,sale_cost_percent,property_tax_percent,maintenance_percent,renter_move_cost_percent_of_annual_rent,capital_gains_tax_percent
1996,2.6,100.0,100.0,6.9,16.0,5.2,3.5,2.5,1.2,1.0,12.5,24.0
1997,2.4,108.5,103.8,7.5,24.7,5.8,3.5,2.5,1.2,1.0,12.5,24.0
1998,1.8,116.2,107.2,7.8,17.8,5.4,3.5,2.5,1.2,1.0,12.5,24.0
1999,1.6,125.4,110.5,6.5,21.1,5.1,3.5,2.5,1.2,1.0,12.5,24.0
2000,0.8,135.1,113.9,6.2,-7.5,4.9,3.5,2.5,1.1,1.0,12.5,24.0
2001,1.2,147.3,117.8,5.6,-13.3,5.3,3.5,2.5,1.1,1.0,12.5,24.0
2002,1.3,163.8,122.3,5.0,-22.7,4.7,3.5,2.5,1.1,1.0,12.5,24.0
2003,1.4,185.6,127.4,4.7,17.9,4.2,3.5,2.5,1.0,1.0,12.5,24.0
2004,1.3,205.9,132.9,5.1,12.8,4.5,3.5,2.5,1.0,1.0,12.5,24.0
2005,2.1,218.7,138.5,5.0,20.9,4.8,3.5,2.5,1.0,1.0,12.5,24.0
2006,2.3,230.4,144.2,5.4,16.8,4.6,3.5,2.5,1.0,1.0,12.5,24.0
2007,2.3,245.1,150.1,6.1,7.4,4.1,3.5,2.5,0.9,1.0,12.5,24.0
2008,3.6,238.6,155.3,6.3,-29.1,3.2,3.5,2.5,0.9,1.0,12.5,18.0
2009,2.2,220.3,158.9,4.2,27.3,-1.5,3.5,2.5,0.9,1.0,12.5,18.0
2010,3.3,228.9,162.7,3.8,12.6,2.1,3.5,2.5,0.9,1.0,12.5,18.0
2011,4.5,230.2,167.4,3.9,-2.2,1.8,3.5,2.5,0.9,1.0,12.5,18.0
2012,2.8,231.5,172.0,4.0,10.5,1.4,3.5,2.5,0.9,1.0,12.5,18.0
2013,2.6,240.8,176.3,3.6,13.0,1.9,3.5,2.5,0.9,1.0,12.5,18.0
2014,1.5,255.6,180.8,3.3,1.2,1.2,4.0,2.5,0.9,1.0,12.5,18.0
2015,0.0,270.1,185.6,3.1,0.9,2.0,4.0,2.5,0.8,1.0,12.5,18.0
2016,0.7,285.4,190.9,3.0,16.5,2.5,4.5,2.5,0.8,1.0,12.5,10.0
2017,2.7,300.2,197.2,3.2,13.1,2.6,4.5,2.5,0.8,1.0,12.5,10.0
2018,2.5,310.7,204.1,3.4,-9.5,3.1,4.5,2.5,0.8,1.0,12.5,10.0
2019,1.8,318.9,211.0,3.3,19.1,3.4,4.5,2.5,0.8,1.0,12.5,10.0
2020,0.9,330.5,216.5,3.1,-9.8,1.8,4.5,2.5,0.8,1.0,12.5,10.0
2021,2.6,360.2,223.8,2.8,18.4,4.0,4.5,2.5,0.7,1.0,12.5,10.0
2022,9.1,385.4,238.5,4.5,-0.9,5.5,4.5,2.5,0.7,1.0,12.5,10.0
2023,7.3,395.1,258.4,6.2,7.9,6.2,4.5,2.5,0.7,1.0,12.5,10.0
2024,2.5,405.8,278.5,5.8,8.7,6.9,4.5,2.5,0.6,1.0,12.5,10.0
2025,3.2,415.0,295.0,5.0,21.6,5.3,4.5,2.5,0.6,1.0,12.5,18.0`;

/**
 * UTILS
 */
const formatCurrency = (val) => {
    if (!isFinite(val)) return "-";
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
    }).format(val).replace('$', '');
};

const parseCSV = (csvText) => {
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',').map(item => parseFloat(item.trim()));
        const entry = {};
        headers.forEach((header, index) => {
            if (index < row.length) entry[header] = row[index];
        });
        if (!entry['capital_gains_tax_percent']) entry['capital_gains_tax_percent'] = 0;
        data.push(entry);
    }
    return data;
};

/**
 * SIMULATOR CORE
 * Calculates all years upfront deterministically.
 */
class Simulator {
    constructor(data, params) {
        this.history = data;
        this.params = params;
        this.moveYears = [];
        if (params.moves > 0) {
            const totalYears = data.length;
            const interval = totalYears / (params.moves + 1);
            for (let m = 1; m <= params.moves; m++) {
                const idx = Math.floor(m * interval);
                this.moveYears.push(data[idx].year);
            }
        }
    }

    run() {
        let buyer = {
            cash: this.params.initialSavings,
            propertyValue: 0,
            mortgageBalance: 0,
            mortgageTermRemaining: 0,
            ownsHome: false,
            annualHousingCost: 0
        };

        let renter = {
            investmentValue: this.params.initialSavings,
            lastReturnPct: 0
        };

        let currentIncome = this.params.startingIncome;
        const simulationStates = [];

        this.history.forEach((row, index) => {
            const year = row.year;
            const isMoveYear = this.moveYears.includes(year);
            
            // Income Growth
            if (index > 0) {
                const growthRate = this.history[index-1].income_growth_rate_percent / 100;
                currentIncome = currentIncome * (1 + growthRate);
            }

            // --- BUYER LOGIC ---
            let buyerStatus = "Renting / Saving";
            
            // Purchase Attempt
            if (!buyer.ownsHome) {
                const propertyPrice = this.params.baseHousePrice * (row.house_price_index / 100);
                const depositNeeded = propertyPrice * this.params.depositPct;
                const purchaseCost = propertyPrice * (row.purchase_cost_percent / 100);
                const totalCashNeeded = depositNeeded + purchaseCost;

                if (buyer.cash >= totalCashNeeded) {
                    buyer.ownsHome = true;
                    buyer.propertyValue = propertyPrice;
                    buyer.mortgageBalance = propertyPrice - depositNeeded;
                    buyer.mortgageTermRemaining = this.params.mortgageTerm;
                    buyer.cash -= totalCashNeeded;
                    buyerStatus = "Purchased Home";
                } else {
                    buyerStatus = "Saving for Deposit";
                }
            }

            if (buyer.ownsHome) {
                // Update Value
                buyer.propertyValue = this.params.baseHousePrice * (row.house_price_index / 100);

                // Costs
                const interestRate = row.mortgage_interest_rate_percent / 100;
                const interestPayment = buyer.mortgageBalance * interestRate;
                // Linear principal repayment
                const principalPayment = buyer.mortgageBalance / buyer.mortgageTermRemaining;
                
                const propertyTax = buyer.propertyValue * (row.property_tax_percent / 100);
                const maintenance = buyer.propertyValue * (row.maintenance_percent / 100);

                buyer.annualHousingCost = interestPayment + principalPayment + propertyTax + maintenance;
                buyerStatus = `Owner (Mortgage: ${(interestRate*100).toFixed(1)}%)`;

                // Cash Flow
                buyer.cash += currentIncome;
                buyer.cash -= buyer.annualHousingCost;

                // Update Mortgage
                buyer.mortgageBalance -= principalPayment;
                buyer.mortgageTermRemaining--;

                // Move Logic
                if (isMoveYear) {
                    buyerStatus = "SOLD & MOVING";
                    const salePrice = buyer.propertyValue;
                    const saleCost = salePrice * (row.sale_cost_percent / 100);
                    const netEquity = salePrice - saleCost - buyer.mortgageBalance;
                    buyer.cash += netEquity;
                    buyer.ownsHome = false;
                    buyer.propertyValue = 0;
                    buyer.mortgageBalance = 0;

                    // Immediate Re-buy attempt
                    const newPropertyPrice = this.params.baseHousePrice * (row.house_price_index / 100);
                    const newDepositNeeded = newPropertyPrice * this.params.depositPct;
                    const newPurchaseCost = newPropertyPrice * (row.purchase_cost_percent / 100);
                    if (buyer.cash >= (newDepositNeeded + newPurchaseCost)) {
                        buyer.ownsHome = true;
                        buyer.propertyValue = newPropertyPrice;
                        buyer.mortgageBalance = newPropertyPrice - newDepositNeeded;
                        buyer.mortgageTermRemaining = this.params.mortgageTerm;
                        buyer.cash -= (newDepositNeeded + newPurchaseCost);
                        buyerStatus = "Moved & Bought New";
                    } else {
                        buyerStatus = "Moved, Renting (Unable to buy)";
                    }
                }
            } else {
                // Just saving cash
                buyer.cash += currentIncome;
                buyer.annualHousingCost = 0;
            }

            const buyerNW = buyer.cash + (buyer.propertyValue - buyer.mortgageBalance);


            // --- RENTER LOGIC ---
            const annualRent = this.params.baseRent * (row.rent_price_index / 100);
            let renterNetCash = currentIncome - annualRent;

            if (isMoveYear) {
                const moveCostPct = row.renter_move_cost_percent_of_annual_rent / 100;
                const moveCost = annualRent * moveCostPct;
                renterNetCash -= moveCost;
            }

            // Investment Return
            const investmentReturn = row.annual_return_percent / 100;
            renter.lastReturnPct = investmentReturn;
            renter.investmentValue = renter.investmentValue * (1 + investmentReturn);
            renter.investmentValue += renterNetCash;

            // Final state for year
            simulationStates.push({
                year: year,
                isMoveYear: isMoveYear,
                buyer: {
                    netWorth: buyerNW,
                    income: currentIncome,
                    houseValue: buyer.propertyValue,
                    mortgage: buyer.mortgageBalance,
                    cash: buyer.cash,
                    annualCost: buyer.annualHousingCost,
                    status: buyerStatus
                },
                renter: {
                    netWorth: renter.investmentValue, // Gross until end
                    income: currentIncome,
                    rent: annualRent,
                    investment: renter.investmentValue,
                    returnPct: investmentReturn
                }
            });
        });

        return simulationStates;
    }
}

/**
 * CHART RENDERER
 */
class ChartRenderer {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.padding = { top: 20, right: 30, bottom: 30, left: 60 };
    }

    resize() {
        const parent = this.canvas.parentElement;
        const dpr = window.devicePixelRatio || 1;
        const rect = parent.getBoundingClientRect();
        this.canvas.width = rect.width * dpr;
        this.canvas.height = rect.height * dpr;
        this.ctx.scale(dpr, dpr);
        this.width = rect.width;
        this.height = rect.height;
    }

    draw(states, upToIndex) {
        this.resize();
        const { ctx, width, height, padding } = this;
        
        ctx.clearRect(0, 0, width, height);

        // Scales
        // We need to predict the max range of the WHOLE simulation to keep the scale stable
        const allValues = states.flatMap(s => [s.buyer.netWorth, s.renter.netWorth]);
        let minVal = Math.min(...allValues);
        let maxVal = Math.max(...allValues);
        const range = maxVal - minVal || 1000;
        
        // Visual padding
        const drawMin = minVal - (range * 0.1);
        const drawMax = maxVal + (range * 0.1);

        const xScale = (width - padding.left - padding.right) / (states.length - 1);
        const yScale = (height - padding.top - padding.bottom) / (drawMax - drawMin);

        const getX = (i) => padding.left + i * xScale;
        const getY = (val) => height - padding.bottom - (val - drawMin) * yScale;

        // Grid
        ctx.strokeStyle = '#e5e5ea';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<=4; i++) {
            const val = drawMin + (i/4)*(drawMax-drawMin);
            const y = getY(val);
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width-padding.right, y);
            // Labels
            ctx.fillStyle = '#86868b';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText((val/1000).toFixed(0)+'k', padding.left-5, y+3);
        }
        ctx.stroke();

        // Draw Lines
        const drawPath = (key, color) => {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Draw up to current index
            for (let i = 0; i <= upToIndex && i < states.length; i++) {
                const x = getX(i);
                const y = getY(states[i][key].netWorth);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw dot at current year
            const curIdx = Math.min(upToIndex, states.length - 1);
            const cx = getX(curIdx);
            const cy = getY(states[curIdx][key].netWorth);
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.arc(cx, cy, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.arc(cx, cy, 2, 0, Math.PI * 2);
            ctx.fill();
        };

        drawPath('buyer', '#0071e3');
        drawPath('renter', '#ff9500');
    }
}

/**
 * APP CONTROLLER
 */
const App = {
    data: null,
    chart: null,
    states: [],
    timer: null,
    currentIndex: 0,
    TICK_RATE: 3000, // 3 seconds per year

    init() {
        this.data = parseCSV(CSV_DATA);
        this.chart = new ChartRenderer('wealthChart');

        // Event Listeners
        document.getElementById('resetBtn').addEventListener('click', () => this.reset());
        document.getElementById('playBtn').addEventListener('click', () => this.togglePlay());
        
        // Initial Setup
        this.reset();
        
        window.addEventListener('resize', () => {
            if (this.states.length) this.chart.draw(this.states, this.currentIndex);
        });
    },

    getParams() {
        return {
            startingIncome: parseFloat(document.getElementById('income').value),
            initialSavings: parseFloat(document.getElementById('savings').value),
            baseHousePrice: parseFloat(document.getElementById('housePrice').value),
            baseRent: parseFloat(document.getElementById('baseRent').value),
            depositPct: parseFloat(document.getElementById('deposit').value),
            mortgageTerm: parseInt(document.getElementById('term').value),
            moves: parseInt(document.getElementById('moves').value)
        };
    },

    reset() {
        this.stop();
        const params = this.getParams();
        const sim = new Simulator(this.data, params);
        this.states = sim.run();
        this.currentIndex = 0;
        
        document.getElementById('playBtn').disabled = false;
        document.getElementById('playBtn').textContent = "Play Simulation";
        
        // Initialize UI to Year 0
        this.updateUI(0);
        this.chart.draw(this.states, 0);
    },

    togglePlay() {
        if (this.timer) {
            this.stop();
            document.getElementById('playBtn').textContent = "Resume Simulation";
        } else {
            if (this.currentIndex >= this.states.length - 1) {
                this.reset(); // Restart if at end
            }
            document.getElementById('playBtn').textContent = "Pause";
            this.timer = setInterval(() => this.tick(), this.TICK_RATE);
            this.tick(); // Run first immediately
        }
    },

    stop() {
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
        }
    },

    tick() {
        if (this.currentIndex >= this.states.length - 1) {
            this.stop();
            document.getElementById('playBtn').textContent = "Simulation Complete";
            return;
        }
        
        this.currentIndex++;
        this.updateUI(this.currentIndex);
        this.chart.draw(this.states, this.currentIndex);
    },

    updateUI(idx) {
        const state = this.states[idx];
        const prev = idx > 0 ? this.states[idx-1] : state;

        // Year
        document.getElementById('displayYear').textContent = state.year;

        // Leader Logic
        const bVal = state.buyer.netWorth;
        const rVal = state.renter.netWorth;
        const badge = document.getElementById('leaderBadge');
        
        if (bVal > rVal) {
            badge.textContent = "Buyer Winning";
            badge.className = "leader-indicator leader-buyer";
        } else if (rVal > bVal) {
            badge.textContent = "Renter Winning";
            badge.className = "leader-indicator leader-renter";
        } else {
            badge.textContent = "Tie";
            badge.className = "leader-indicator leader-tie";
        }

        // Buyer Updates
        document.getElementById('buyerNetWorth').textContent = formatCurrency(bVal);
        document.getElementById('buyerIncome').textContent = formatCurrency(state.buyer.income);
        document.getElementById('buyerHouseVal').textContent = formatCurrency(state.buyer.houseValue);
        document.getElementById('buyerMortgage').textContent = formatCurrency(state.buyer.mortgage);
        document.getElementById('buyerCash').textContent = formatCurrency(state.buyer.cash);
        document.getElementById('buyerCost').textContent = formatCurrency(state.buyer.annualCost);
        document.getElementById('buyerStatusBadge').textContent = state.buyer.status;

        // Renter Updates
        document.getElementById('renterNetWorth').textContent = formatCurrency(rVal);
        document.getElementById('renterIncome').textContent = formatCurrency(state.renter.income);
        document.getElementById('renterRent').textContent = formatCurrency(state.renter.rent);
        document.getElementById('renterInvest').textContent = formatCurrency(state.renter.investment);
        
        const retEl = document.getElementById('renterReturn');
        const retPct = (state.renter.returnPct * 100).toFixed(1);
        retEl.textContent = retPct + "%";
        retEl.className = "stat-value " + (state.renter.returnPct >= 0 ? "positive-change" : "negative-change");

        // Event Flash
        const flash = document.getElementById('eventFlash');
        if (state.isMoveYear) {
            flash.textContent = "MOVING YEAR";
            flash.classList.add('visible');
            setTimeout(() => flash.classList.remove('visible'), 2000);
        } else if (state.renter.returnPct < -0.1) {
            flash.textContent = "MARKET CRASH";
            flash.style.background = "#ff3b30";
            flash.classList.add('visible');
            setTimeout(() => {
                flash.classList.remove('visible');
                flash.style.background = "rgba(0,0,0,0.8)";
            }, 2000);
        }
    }
};

document.addEventListener('DOMContentLoaded', () => {
    App.init();
});

</script>
</body>
</html>