<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Jars</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        :root {
            --primary: #5B8CFF;
            --primary-light: #E8F0FF;
            --secondary: #FF9F5B;
            --secondary-light: #FFF1E8;
            --success: #5BCF7F;
            --success-light: #E8F8ED;
            --text: #333333;
            --text-light: #666666;
            --text-lighter: #999999;
            --background: #F9FAFF;
            --card: #FFFFFF;
            --shadow: rgba(91, 140, 255, 0.08);
            --border: #E6E9F0;
            --radius: 20px;
            --radius-sm: 12px;
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 48px;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 80px; /* Space for bottom nav */
            max-width: 500px;
            margin: 0 auto;
        }

        .container {
            padding: var(--spacing-sm);
        }

        /* Typography */
        h1, h2, h3 {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        h1 {
            font-size: 28px;
        }

        h2 {
            font-size: 24px;
        }

        h3 {
            font-size: 20px;
        }

        .large-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
        }

        .medium-number {
            font-size: 32px;
            font-weight: 600;
            line-height: 1;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-light);
        }

        .text-very-muted {
            color: var(--text-lighter);
            font-size: 14px;
        }

        /* Cards */
        .card {
            background-color: var(--card);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .jar-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .jar-card:hover, .jar-card:active {
            transform: translateY(-2px);
        }

        .jar-card-info {
            flex: 1;
        }

        .jar-card-amount {
            font-weight: 600;
            font-size: 24px;
        }

        /* Status Messages */
        .status-message {
            background-color: var(--success-light);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--success);
        }

        .nudge-message {
            background-color: var(--primary-light);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--primary);
        }

        /* Forms and Inputs */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-light);
        }

        .input-amount {
            font-size: 48px;
            font-weight: 700;
            border: none;
            background: transparent;
            width: 100%;
            text-align: center;
            color: var(--text);
            outline: none;
            margin: var(--spacing-md) 0;
        }

        .input-amount::placeholder {
            color: var(--text-lighter);
        }

        .select-jar, .input-text {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 16px;
            background-color: white;
            outline: none;
            transition: border-color 0.2s;
        }

        .select-jar:focus, .input-text:focus {
            border-color: var(--primary);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-xs);
        }

        .radio-option {
            flex: 1;
            min-width: 120px;
        }

        .radio-input {
            display: none;
        }

        .radio-label {
            display: block;
            padding: var(--spacing-sm);
            text-align: center;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-input:checked + .radio-label {
            background-color: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        /* Existing Bills Suggestions */
        .existing-bills {
            margin-top: var(--spacing-xs);
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background-color: white;
            display: none;
        }

        .existing-bill-item {
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .existing-bill-item:last-child {
            border-bottom: none;
        }

        .existing-bill-item:hover {
            background-color: var(--primary-light);
        }

        .existing-bill-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .existing-bill-details {
            font-size: 14px;
            color: var(--text-light);
        }

        .existing-bill-duplicate {
            background-color: #FFF8E8;
            border-left: 3px solid #FFC107;
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: var(--spacing-md);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover, .btn-primary:active {
            background-color: #4A7AFF;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover, .btn-secondary:active {
            background-color: #FF8E47;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover, .btn-success:active {
            background-color: #4AC274;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover, .btn-outline:active {
            background-color: var(--primary-light);
        }

        .btn-small {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 14px;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--primary);
            text-decoration: underline;
            font-size: 16px;
            cursor: pointer;
            padding: var(--spacing-xs);
            text-align: left;
            width: auto;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            max-width: 500px;
            margin: 0 auto;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-light);
            font-size: 12px;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            flex: 1;
            max-width: 80px;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--primary);
            background-color: var(--primary-light);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Screens */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
        }

        .month-display {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Bill Items */
        .bill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border);
        }

        .bill-item:last-child {
            border-bottom: none;
        }

        .bill-info {
            flex: 1;
        }

        .bill-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .bill-details {
            font-size: 14px;
            color: var(--text-light);
        }

        .bill-amount {
            font-weight: 600;
            font-size: 18px;
        }

        .bill-paid {
            opacity: 0.6;
        }

        .bill-paid .bill-name {
            text-decoration: line-through;
        }

        .section-title {
            font-size: 18px;
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            color: var(--text-light);
            padding-left: var(--spacing-sm);
        }

        /* Activity List */
        .activity-list {
            margin-top: var(--spacing-md);
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .activity-item:hover {
            background-color: var(--primary-light);
            border-radius: var(--radius-sm);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-description {
            flex: 1;
        }

        .activity-note {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .activity-amount-in {
            color: var(--success);
            font-weight: 600;
        }

        .activity-amount-out {
            color: var(--secondary);
            font-weight: 600;
        }

        .activity-date {
            font-size: 12px;
            color: var(--text-lighter);
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--success);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 18px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
            display: none;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        /* Bill History Items */
        .history-item {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            background-color: white;
            border: 1px solid var(--border);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--border);
        }

        .history-months {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }

        .history-month {
            text-align: center;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            background-color: var(--background);
        }

        .history-month-current {
            background-color: var(--primary-light);
            border: 1px solid var(--primary);
        }

        .history-month-name {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .history-month-amount {
            font-weight: 600;
            font-size: 14px;
        }

        .history-month-paid {
            color: var(--success);
        }

        .history-month-unpaid {
            color: var(--text-lighter);
        }

        /* Edit Transaction Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: var(--spacing-sm);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background-color: var(--background);
        }

        .modal-content {
            padding: var(--spacing-md);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .modal-actions .btn {
            flex: 1;
        }

        .btn-remove {
            background-color: #FF5B5B;
            color: white;
        }

        .btn-remove:hover {
            background-color: #FF4747;
        }

        /* Quick Actions */
        .quick-action {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(91, 140, 255, 0.3);
        }

        .quick-action:hover {
            transform: scale(1.1);
            background-color: #4A7AFF;
        }

        /* Utility Classes */
        .mt-sm { margin-top: var(--spacing-sm); }
        .mt-md { margin-top: var(--spacing-md); }
        .mt-lg { margin-top: var(--spacing-lg); }
        .mb-sm { margin-bottom: var(--spacing-sm); }
        .mb-md { margin-bottom: var(--spacing-md); }
        .mb-lg { margin-bottom: var(--spacing-lg); }

        /* Responsive Adjustments */
        @media (min-width: 500px) {
            body {
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
                min-height: 100vh;
            }
        }
    </style>
</head>
<body>
    <!-- Success Message Overlay -->
    <div class="success-message" id="successMessage"></div>

    <!-- Edit Transaction Modal -->
    <div class="modal-overlay" id="editTransactionModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Fix mistake</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="text-muted" id="transactionDate">Date</div>
                    <div style="font-size: 18px; margin: var(--spacing-sm) 0;" id="transactionDescription"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" 
                           class="input-text" 
                           id="editAmount" 
                           placeholder="0" 
                           min="0" 
                           step="0.01" 
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editJar">Jar</label>
                    <select class="select-jar" id="editJar" required>
                        <!-- Jars will be dynamically populated -->
                    </select>
                </div>
                
                <div class="form-group" id="editNoteContainer">
                    <label class="form-label" for="editNote">Note (optional)</label>
                    <input type="text" 
                           class="input-text" 
                           id="editNote" 
                           placeholder="Add a note">
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-remove" id="removeTransactionBtn">Remove</button>
                    <button class="btn btn-primary" id="saveTransactionBtn">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Home Screen -->
    <div class="screen active" id="homeScreen">
        <div class="container">
            <div class="app-header">
                <h1>Money Jars</h1>
                <div class="month-display" id="currentMonth">This month</div>
            </div>

            <div class="card text-center">
                <div class="text-muted">You have</div>
                <div class="large-number" id="totalBalance">0</div>
            </div>

            <div class="status-message" id="statusMessage">
                Everything seems okay.
            </div>

            <div class="nudge-message" id="nudgeMessage" style="display: none;">
                <!-- Nudge messages will appear here -->
            </div>

            <h2>Your Jars</h2>
            <div id="jarsContainer">
                <!-- Jars will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Add Money Screen -->
    <div class="screen" id="addMoneyScreen">
        <div class="container">
            <div class="app-header">
                <h1>Money came in</h1>
            </div>

            <form id="addMoneyForm">
                <div class="form-group">
                    <input type="number" 
                           class="input-amount" 
                           id="addMoneyAmount" 
                           placeholder="0" 
                           min="0" 
                           step="0.01" 
                           required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="addMoneyJar">Where did it go?</label>
                    <select class="select-jar" id="addMoneyJar" required>
                        <!-- Jars will be dynamically populated -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="addMoneySource">Where did it come from? (optional)</label>
                    <input type="text" 
                           class="input-text" 
                           id="addMoneySource" 
                           placeholder="e.g., paycheck, gift, found money">
                </div>

                <button type="submit" class="btn btn-primary">Add money</button>
            </form>
        </div>
    </div>

    <!-- Spend Money Screen -->
    <div class="screen" id="spendMoneyScreen">
        <div class="container">
            <div class="app-header">
                <h1>Money went out</h1>
            </div>

            <form id="spendMoneyForm">
                <div class="form-group">
                    <input type="number" 
                           class="input-amount" 
                           id="spendMoneyAmount" 
                           placeholder="0" 
                           min="0" 
                           step="0.01" 
                           required>
                </div>

                <div class="form-group">
                    <label class="form-label">What was it for?</label>
                    <div class="radio-group" id="spendCategoryGroup">
                        <!-- Categories will be dynamically populated -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="spendMoneyJar">Which jar?</label>
                    <select class="select-jar" id="spendMoneyJar" required>
                        <!-- Jars will be dynamically populated -->
                    </select>
                </div>

                <button type="submit" class="btn btn-secondary">Done</button>
            </form>
        </div>
    </div>

    <!-- Bills Screen -->
    <div class="screen" id="billsScreen">
        <div class="container">
            <div class="app-header">
                <h1>Bills this month</h1>
                <div class="header-actions">
                    <button class="btn-link" id="viewBillHistoryBtn">Past bills</button>
                </div>
            </div>

            <div class="section-title">Coming up</div>
            <div id="upcomingBills">
                <!-- Upcoming bills will be dynamically inserted here -->
            </div>

            <div class="section-title">Paid</div>
            <div id="paidBills">
                <!-- Paid bills will be dynamically inserted here -->
            </div>

            <button class="btn btn-outline mt-lg" id="addBillBtn">Add a bill</button>
        </div>
    </div>

    <!-- Add/Edit Bill Screen -->
    <div class="screen" id="addBillScreen">
        <div class="container">
            <div class="app-header">
                <h1 id="addBillTitle">Add a bill</h1>
            </div>

            <form id="addBillForm">
                <div class="form-group">
                    <label class="form-label" for="billName">What is it?</label>
                    <input type="text" 
                           class="input-text" 
                           id="billName" 
                           placeholder="e.g., Rent, Electricity, Internet" 
                           required
                           autocomplete="off">
                    <div class="existing-bills" id="existingBillsList">
                        <!-- Existing bills will appear here as user types -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">How often?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="frequencyFixed" name="frequency" value="fixed" class="radio-input" checked>
                            <label for="frequencyFixed" class="radio-label">Every month</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="frequencyVariable" name="frequency" value="variable" class="radio-input">
                            <label for="frequencyVariable" class="radio-label">Changes each month</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="billAmount">Amount (fixed)</label>
                    <input type="number" 
                           class="input-text" 
                           id="billAmount" 
                           placeholder="0" 
                           min="0" 
                           step="0.01" 
                           required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="billDueDay">Due day</label>
                    <input type="number" 
                           class="input-text" 
                           id="billDueDay" 
                           placeholder="1-31" 
                           min="1" 
                           max="31" 
                           required>
                </div>

                <button type="submit" class="btn btn-primary" id="saveBillBtn">Save bill</button>
            </form>
        </div>
    </div>

    <!-- Bill History Screen -->
    <div class="screen" id="billHistoryScreen">
        <div class="container">
            <div class="app-header">
                <h1>Past bills</h1>
            </div>

            <div class="text-muted mb-md">
                Showing last 6 months of bill history
            </div>

            <div id="billHistoryContainer">
                <!-- Bill history will be dynamically inserted here -->
            </div>

            <button class="btn btn-outline mt-lg" id="backToBillsBtn">Back to bills</button>
        </div>
    </div>

    <!-- Jar Detail Screen -->
    <div class="screen" id="jarDetailScreen">
        <div class="container">
            <div class="app-header">
                <h1 id="jarDetailName">Jar</h1>
            </div>

            <div class="card text-center">
                <div class="text-muted">You have</div>
                <div class="large-number" id="jarDetailBalance">0</div>
            </div>

            <div class="activity-list" id="jarActivityList">
                <h3>Recent activity</h3>
                <!-- Activity items will be dynamically inserted here -->
            </div>

            <div class="mt-lg">
                <button class="btn btn-primary mb-sm" id="addToJarBtn">Add money</button>
                <button class="btn btn-outline" id="spendFromJarBtn">Spend money</button>
            </div>
        </div>
    </div>

    <!-- All Activity Screen -->
    <div class="screen" id="allActivityScreen">
        <div class="container">
            <div class="app-header">
                <h1>All activity</h1>
            </div>

            <div class="text-muted mb-md">
                Tap any item to fix a mistake
            </div>

            <div id="allActivityContainer">
                <!-- All activity will be dynamically inserted here -->
            </div>

            <button class="btn btn-outline mt-lg" id="backToHomeFromActivityBtn">Back to home</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="#" class="nav-item active" data-screen="homeScreen">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" data-screen="addMoneyScreen">
            <i class="fas fa-plus-circle nav-icon"></i>
            <span>Add</span>
        </a>
        <a href="#" class="nav-item" data-screen="spendMoneyScreen">
            <i class="fas fa-minus-circle nav-icon"></i>
            <span>Spend</span>
        </a>
        <a href="#" class="nav-item" data-screen="billsScreen">
            <i class="fas fa-file-invoice-dollar nav-icon"></i>
            <span>Bills</span>
        </a>
    </div>

    <!-- Quick Action Button -->
    <button class="quick-action" id="viewAllActivityBtn" title="View all activity">
        <i class="fas fa-history"></i>
    </button>

    <script>
        // Money Jars App - With Transaction Editing
        // Now with simple transaction editing and removal

        // =========================================================================
        // DATA MODEL AND STATE MANAGEMENT
        // =========================================================================

        // App state
        const AppState = {
            currentScreen: 'homeScreen',
            currentJarId: null,
            currentBillId: null,
            currentTransactionId: null,
            categories: ['Food', 'Coffee', 'Groceries', 'Clothes', 'Family', 'Something else'],
            lastNudgeDate: null,
            isInitialized: false,
            billHistoryMonths: 6 // How many months of history to show
        };

        // Data models
        const DataModel = {
            // Initialize default data structure
            init: function() {
                // Check if app is already initialized
                if (localStorage.getItem('moneyJars_initialized') === 'true') {
                    this.loadFromStorage();
                    AppState.isInitialized = true;
                    return;
                }

                // Create default jars
                this.jars = [
                    {
                        id: 'bills-jar',
                        name: 'Bills',
                        amount: 0,
                        removable: false,
                        color: '#5B8CFF'
                    },
                    {
                        id: 'everyday-jar',
                        name: 'Everyday',
                        amount: 0,
                        removable: false,
                        color: '#FF9F5B'
                    },
                    {
                        id: 'savings-jar',
                        name: 'Savings',
                        amount: 0,
                        removable: true,
                        color: '#5BCF7F'
                    }
                ];

                // Initialize other data structures
                this.movements = [];
                this.bills = [];
                this.billPaymentHistory = [];
                this.appState = {
                    currentMonth: new Date().getMonth(),
                    currentYear: new Date().getFullYear(),
                    lastNudgeDate: null
                };

                // Save to localStorage
                this.saveToStorage();
                localStorage.setItem('moneyJars_initialized', 'true');
                AppState.isInitialized = true;
            },

            // Save all data to localStorage
            saveToStorage: function() {
                localStorage.setItem('moneyJars_jars', JSON.stringify(this.jars));
                localStorage.setItem('moneyJars_movements', JSON.stringify(this.movements));
                localStorage.setItem('moneyJars_bills', JSON.stringify(this.bills));
                localStorage.setItem('moneyJars_billPaymentHistory', JSON.stringify(this.billPaymentHistory));
                localStorage.setItem('moneyJars_appState', JSON.stringify(this.appState));
            },

            // Load all data from localStorage
            loadFromStorage: function() {
                this.jars = JSON.parse(localStorage.getItem('moneyJars_jars') || '[]');
                this.movements = JSON.parse(localStorage.getItem('moneyJars_movements') || '[]');
                this.bills = JSON.parse(localStorage.getItem('moneyJars_bills') || '[]');
                this.billPaymentHistory = JSON.parse(localStorage.getItem('moneyJars_billPaymentHistory') || '[]');
                this.appState = JSON.parse(localStorage.getItem('moneyJars_appState') || '{"currentMonth":0,"currentYear":2023,"lastNudgeDate":null}');
            },

            // Get total balance across all jars
            getTotalBalance: function() {
                return this.jars.reduce((total, jar) => total + jar.amount, 0);
            },

            // Get a jar by ID
            getJarById: function(id) {
                return this.jars.find(jar => jar.id === id);
            },

            // Get a movement by ID
            getMovementById: function(id) {
                return this.movements.find(movement => movement.id === id);
            },

            // Add a money movement
            addMovement: function(amount, direction, jarId, description, note = '') {
                const movement = {
                    id: Date.now().toString(),
                    amount: parseFloat(amount),
                    direction: direction, // 'in' or 'out'
                    jarId: jarId,
                    date: new Date().toISOString(),
                    description: description,
                    note: note
                };

                this.movements.push(movement);

                // Update jar amount
                const jar = this.getJarById(jarId);
                if (jar) {
                    if (direction === 'in') {
                        jar.amount += parseFloat(amount);
                    } else {
                        jar.amount -= parseFloat(amount);
                    }
                }

                this.saveToStorage();
                return movement;
            },

            // Update a money movement
            updateMovement: function(movementId, newAmount, newJarId, newNote = '') {
                const movement = this.getMovementById(movementId);
                if (!movement) return false;
                
                const oldAmount = movement.amount;
                const oldJarId = movement.jarId;
                const oldDirection = movement.direction;
                
                // First, reverse the old transaction
                const oldJar = this.getJarById(oldJarId);
                if (oldJar) {
                    if (oldDirection === 'in') {
                        oldJar.amount -= oldAmount;
                    } else {
                        oldJar.amount += oldAmount;
                    }
                }
                
                // Update movement details
                movement.amount = parseFloat(newAmount);
                movement.jarId = newJarId;
                movement.note = newNote;
                movement.updatedDate = new Date().toISOString();
                
                // Apply the updated transaction
                const newJar = this.getJarById(newJarId);
                if (newJar) {
                    if (oldDirection === 'in') {
                        newJar.amount += parseFloat(newAmount);
                    } else {
                        newJar.amount -= parseFloat(newAmount);
                    }
                }
                
                this.saveToStorage();
                return true;
            },

            // Remove a money movement
            removeMovement: function(movementId) {
                const movementIndex = this.movements.findIndex(m => m.id === movementId);
                if (movementIndex === -1) return false;
                
                const movement = this.movements[movementIndex];
                
                // Reverse the transaction on the jar
                const jar = this.getJarById(movement.jarId);
                if (jar) {
                    if (movement.direction === 'in') {
                        jar.amount -= movement.amount;
                    } else {
                        jar.amount += movement.amount;
                    }
                }
                
                // Remove the movement
                this.movements.splice(movementIndex, 1);
                this.saveToStorage();
                return true;
            },

            // Add a bill
            addBill: function(name, frequency, amount, dueDay) {
                const bill = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    frequency: frequency, // 'fixed' or 'variable'
                    amount: parseFloat(amount),
                    dueDay: parseInt(dueDay),
                    lastPaidMonth: null,
                    lastPaidYear: null,
                    lastAmount: frequency === 'variable' ? parseFloat(amount) : null,
                    createdDate: new Date().toISOString()
                };

                this.bills.push(bill);
                this.saveToStorage();
                return bill;
            },

            // Find bills with similar names (for duplicate detection)
            findSimilarBills: function(billName) {
                if (!billName || billName.trim().length < 3) {
                    return [];
                }
                
                const searchName = billName.trim().toLowerCase();
                return this.bills.filter(bill => {
                    const billNameLower = bill.name.toLowerCase();
                    // Check for exact match or contains
                    return billNameLower === searchName || 
                           billNameLower.includes(searchName) || 
                           searchName.includes(billNameLower);
                });
            },

            // Mark a bill as paid
            markBillAsPaid: function(billId, amount = null) {
                const bill = this.bills.find(b => b.id === billId);
                if (!bill) return false;

                const currentDate = new Date();
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                
                bill.lastPaidMonth = currentMonth;
                bill.lastPaidYear = currentYear;
                
                // If variable bill, update the last amount
                const paidAmount = amount !== null ? parseFloat(amount) : bill.amount;
                if (bill.frequency === 'variable') {
                    bill.lastAmount = paidAmount;
                }

                // Record in payment history
                this.recordBillPayment(billId, bill.name, paidAmount, currentMonth, currentYear);

                // Deduct from bills jar
                const billsJar = this.getJarById('bills-jar');
                if (billsJar) {
                    billsJar.amount -= paidAmount;
                    
                    // Create a movement for the bill payment
                    this.addMovement(
                        paidAmount, 
                        'out', 
                        'bills-jar', 
                        bill.name, 
                        'Bill payment'
                    );
                }

                this.saveToStorage();
                return true;
            },

            // Record bill payment in history
            recordBillPayment: function(billId, billName, amount, month, year) {
                // Find existing history for this bill
                let billHistory = this.billPaymentHistory.find(h => h.billId === billId);
                
                if (!billHistory) {
                    billHistory = {
                        billId: billId,
                        billName: billName,
                        payments: []
                    };
                    this.billPaymentHistory.push(billHistory);
                }
                
                // Add payment record
                billHistory.payments.push({
                    month: month,
                    year: year,
                    amount: amount,
                    paidDate: new Date().toISOString()
                });
                
                // Keep only the last 6 months of payments per bill
                billHistory.payments.sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    return b.month - a.month;
                });
                
                if (billHistory.payments.length > AppState.billHistoryMonths) {
                    billHistory.payments = billHistory.payments.slice(0, AppState.billHistoryMonths);
                }
                
                this.saveToStorage();
            },

            // Get bills for the current month
            getBillsForCurrentMonth: function() {
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                const today = currentDate.getDate();
                
                const upcoming = [];
                const paid = [];
                
                this.bills.forEach(bill => {
                    const isPaid = bill.lastPaidMonth === currentMonth && bill.lastPaidYear === currentYear;
                    
                    if (isPaid) {
                        paid.push(bill);
                    } else {
                        // Check if bill is due soon (within 7 days)
                        const daysUntilDue = bill.dueDay - today;
                        upcoming.push({
                            ...bill,
                            daysUntilDue: daysUntilDue
                        });
                    }
                });
                
                // Sort upcoming bills by due date
                upcoming.sort((a, b) => a.dueDay - b.dueDay);
                
                return { upcoming, paid };
            },

            // Get bill payment history for display
            getBillPaymentHistory: function() {
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                
                // Get the last 6 months including current
                const months = [];
                for (let i = 0; i < AppState.billHistoryMonths; i++) {
                    let month = currentMonth - i;
                    let year = currentYear;
                    
                    if (month < 0) {
                        month += 12;
                        year -= 1;
                    }
                    
                    months.push({
                        month: month,
                        year: year,
                        name: this.getMonthName(month)
                    });
                }
                
                // Create history for each bill
                const billHistory = this.bills.map(bill => {
                    const history = {
                        billId: bill.id,
                        billName: bill.name,
                        dueDay: bill.dueDay,
                        months: []
                    };
                    
                    // For each month, check if bill was paid
                    months.forEach(monthData => {
                        const payment = this.billPaymentHistory
                            .find(h => h.billId === bill.id)
                            ?.payments.find(p => p.month === monthData.month && p.year === monthData.year);
                        
                        history.months.push({
                            ...monthData,
                            paid: !!payment,
                            amount: payment ? payment.amount : bill.amount,
                            isCurrentMonth: monthData.month === currentMonth && monthData.year === currentYear
                        });
                    });
                    
                    return history;
                });
                
                return billHistory;
            },

            // Get month name
            getMonthName: function(month) {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return monthNames[month];
            },

            // Get movements for a specific jar
            getMovementsForJar: function(jarId, limit = 10) {
                return this.movements
                    .filter(movement => movement.jarId === jarId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, limit);
            },

            // Get all movements for the current month
            getRecentMovements: function(limit = 50) {
                return this.movements
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, limit);
            },

            // Check if bills are covered
            areBillsCovered: function() {
                const billsJar = this.getJarById('bills-jar');
                if (!billsJar) return false;
                
                const currentMonthBills = this.getBillsForCurrentMonth();
                const totalUpcoming = currentMonthBills.upcoming.reduce((total, bill) => {
                    return total + (bill.frequency === 'variable' ? bill.lastAmount || bill.amount : bill.amount);
                }, 0);
                
                return billsJar.amount >= totalUpcoming;
            },

            // Check if we should show a nudge
            shouldShowNudge: function() {
                // Max once per week
                if (AppState.lastNudgeDate) {
                    const lastNudge = new Date(AppState.lastNudgeDate);
                    const now = new Date();
                    const daysSinceLastNudge = Math.floor((now - lastNudge) / (1000 * 60 * 60 * 24));
                    
                    if (daysSinceLastNudge < 7) {
                        return false;
                    }
                }
                
                // Check for nudging conditions
                const savingsJar = this.getJarById('savings-jar');
                const today = new Date();
                const dayOfMonth = today.getDate();
                
                // Nudge about savings if it's the end of the month and savings are low
                if (dayOfMonth > 25 && savingsJar && savingsJar.amount < 100) {
                    return "You could put a little in savings before the month ends.";
                }
                
                // Nudge about bills if they're not covered
                if (!this.areBillsCovered() && dayOfMonth > 20) {
                    return "Let's make sure bills are covered this month.";
                }
                
                return null;
            }
        };

        // =========================================================================
        // DOM ELEMENT REFERENCES
        // =========================================================================

        // Screens
        const screens = {
            home: document.getElementById('homeScreen'),
            addMoney: document.getElementById('addMoneyScreen'),
            spendMoney: document.getElementById('spendMoneyScreen'),
            bills: document.getElementById('billsScreen'),
            addBill: document.getElementById('addBillScreen'),
            billHistory: document.getElementById('billHistoryScreen'),
            jarDetail: document.getElementById('jarDetailScreen'),
            allActivity: document.getElementById('allActivityScreen')
        };

        // Home screen elements
        const totalBalanceEl = document.getElementById('totalBalance');
        const statusMessageEl = document.getElementById('statusMessage');
        const nudgeMessageEl = document.getElementById('nudgeMessage');
        const jarsContainerEl = document.getElementById('jarsContainer');
        const currentMonthEl = document.getElementById('currentMonth');

        // Forms
        const addMoneyForm = document.getElementById('addMoneyForm');
        const spendMoneyForm = document.getElementById('spendMoneyForm');
        const addBillForm = document.getElementById('addBillForm');

        // Bill management elements
        const billNameInput = document.getElementById('billName');
        const existingBillsList = document.getElementById('existingBillsList');
        const viewBillHistoryBtn = document.getElementById('viewBillHistoryBtn');
        const backToBillsBtn = document.getElementById('backToBillsBtn');
        const billHistoryContainer = document.getElementById('billHistoryContainer');

        // Activity elements
        const allActivityContainer = document.getElementById('allActivityContainer');
        const viewAllActivityBtn = document.getElementById('viewAllActivityBtn');
        const backToHomeFromActivityBtn = document.getElementById('backToHomeFromActivityBtn');

        // Modal elements
        const editTransactionModal = document.getElementById('editTransactionModal');
        const modalClose = document.getElementById('modalClose');
        const transactionDateEl = document.getElementById('transactionDate');
        const transactionDescriptionEl = document.getElementById('transactionDescription');
        const editAmountInput = document.getElementById('editAmount');
        const editJarSelect = document.getElementById('editJar');
        const editNoteInput = document.getElementById('editNote');
        const editNoteContainer = document.getElementById('editNoteContainer');
        const removeTransactionBtn = document.getElementById('removeTransactionBtn');
        const saveTransactionBtn = document.getElementById('saveTransactionBtn');

        // Success message
        const successMessageEl = document.getElementById('successMessage');

        // =========================================================================
        // UTILITY FUNCTIONS
        // =========================================================================

        // Format a number as currency (without symbol)
        function formatNumber(amount) {
            return parseFloat(amount).toFixed(2);
        }

        // Format a date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Format date for modal display
        function formatDateForModal(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Show a success message
        function showSuccessMessage(message) {
            successMessageEl.textContent = message;
            successMessageEl.style.display = 'block';
            
            setTimeout(() => {
                successMessageEl.style.display = 'none';
            }, 2000);
        }

        // Switch between screens
        function showScreen(screenId) {
            // Hide all screens
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the requested screen
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active');
                AppState.currentScreen = screenId;
            }
            
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(navItem => {
                if (navItem.getAttribute('data-screen') === screenId) {
                    navItem.classList.add('active');
                } else {
                    navItem.classList.remove('active');
                }
            });
            
            // Refresh specific screens when shown
            if (screenId === 'homeScreen') {
                renderHomeScreen();
            } else if (screenId === 'billsScreen') {
                renderBillsScreen();
            } else if (screenId === 'billHistoryScreen') {
                renderBillHistoryScreen();
            } else if (screenId === 'allActivityScreen') {
                renderAllActivityScreen();
            }
        }

        // Show modal
        function showModal() {
            editTransactionModal.classList.add('active');
        }

        // Hide modal
        function hideModal() {
            editTransactionModal.classList.remove('active');
        }

        // Populate jar select dropdowns
        function populateJarSelects() {
            const jarSelects = document.querySelectorAll('.select-jar');
            
            jarSelects.forEach(select => {
                // Clear existing options
                while (select.options.length > 0) {
                    select.remove(0);
                }
                
                // Add default option (except for edit modal)
                if (select.id !== 'editJar') {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Choose a jar';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    select.appendChild(defaultOption);
                }
                
                // Add jar options
                DataModel.jars.forEach(jar => {
                    const option = document.createElement('option');
                    option.value = jar.id;
                    option.textContent = jar.name;
                    select.appendChild(option);
                });
            });
        }

        // =========================================================================
        // TRANSACTION EDITING FUNCTIONS
        // =========================================================================

        // Open transaction editing modal
        function openEditTransactionModal(movementId) {
            const movement = DataModel.getMovementById(movementId);
            if (!movement) return;
            
            AppState.currentTransactionId = movementId;
            
            // Populate modal fields
            transactionDateEl.textContent = formatDateForModal(movement.date);
            transactionDescriptionEl.textContent = movement.description;
            editAmountInput.value = formatNumber(movement.amount);
            editNoteInput.value = movement.note || '';
            
            // Populate jar select for edit modal
            populateJarSelects();
            
            // Set selected jar
            setTimeout(() => {
                editJarSelect.value = movement.jarId;
            }, 0);
            
            // Show note field for "Money came in" transactions
            if (movement.description === 'Money came in') {
                editNoteContainer.style.display = 'block';
                editNoteInput.placeholder = 'Where did it come from?';
            } else if (movement.description === 'Money went out') {
                editNoteContainer.style.display = 'block';
                editNoteInput.placeholder = 'What was it for?';
            } else {
                // For bill payments, note field is less important
                editNoteContainer.style.display = 'block';
                editNoteInput.placeholder = 'Add a note';
            }
            
            showModal();
        }

        // Handle save transaction changes
        saveTransactionBtn.addEventListener('click', function() {
            const movementId = AppState.currentTransactionId;
            const newAmount = editAmountInput.value;
            const newJarId = editJarSelect.value;
            const newNote = editNoteInput.value;
            
            if (!movementId || !newAmount || parseFloat(newAmount) <= 0 || !newJarId) {
                showSuccessMessage('Please fill all fields');
                return;
            }
            
            // Update the movement
            const success = DataModel.updateMovement(movementId, newAmount, newJarId, newNote);
            
            if (success) {
                showSuccessMessage('Mistake fixed ');
                hideModal();
                
                // Refresh the current screen
                if (AppState.currentScreen === 'jarDetailScreen') {
                    renderJarDetailScreen();
                } else if (AppState.currentScreen === 'allActivityScreen') {
                    renderAllActivityScreen();
                } else {
                    renderHomeScreen();
                }
            } else {
                showSuccessMessage('Could not update');
            }
        });

        // Handle remove transaction
        removeTransactionBtn.addEventListener('click', function() {
            const movementId = AppState.currentTransactionId;
            
            if (!movementId) return;
            
            // Simple confirmation (no dialog, just double-check)
            const movement = DataModel.getMovementById(movementId);
            if (movement && confirm(`Remove ${movement.description} for ${formatNumber(movement.amount)}?`)) {
                const success = DataModel.removeMovement(movementId);
                
                if (success) {
                    showSuccessMessage('Removed');
                    hideModal();
                    
                    // Refresh the current screen
                    if (AppState.currentScreen === 'jarDetailScreen') {
                        renderJarDetailScreen();
                    } else if (AppState.currentScreen === 'allActivityScreen') {
                        renderAllActivityScreen();
                    } else {
                        renderHomeScreen();
                    }
                } else {
                    showSuccessMessage('Could not remove');
                }
            }
        });

        // Close modal handlers
        modalClose.addEventListener('click', hideModal);
        editTransactionModal.addEventListener('click', function(e) {
            if (e.target === editTransactionModal) {
                hideModal();
            }
        });

        // =========================================================================
        // BILL MANAGEMENT FUNCTIONS
        // =========================================================================

        // Show existing bills as user types
        function showExistingBillsSuggestions(searchTerm) {
            existingBillsList.innerHTML = '';
            
            if (!searchTerm || searchTerm.trim().length < 2) {
                existingBillsList.style.display = 'none';
                return;
            }
            
            const similarBills = DataModel.findSimilarBills(searchTerm);
            
            if (similarBills.length === 0) {
                existingBillsList.style.display = 'none';
                return;
            }
            
            // Check for exact match
            const exactMatch = similarBills.find(bill => 
                bill.name.toLowerCase() === searchTerm.trim().toLowerCase()
            );
            
            if (exactMatch) {
                // Show duplicate warning
                const duplicateItem = document.createElement('div');
                duplicateItem.className = 'existing-bill-item existing-bill-duplicate';
                duplicateItem.innerHTML = `
                    <div class="existing-bill-name">${exactMatch.name}</div>
                    <div class="existing-bill-details">
                        Already exists  Due day ${exactMatch.dueDay}  ${exactMatch.frequency === 'fixed' ? 'Fixed amount' : 'Variable amount'}
                    </div>
                    <div class="text-very-muted mt-xs">This looks like the same bill</div>
                `;
                
                duplicateItem.addEventListener('click', function() {
                    // Pre-fill the form with existing bill details
                    billNameInput.value = exactMatch.name;
                    document.getElementById('billDueDay').value = exactMatch.dueDay;
                    document.getElementById('billAmount').value = formatNumber(exactMatch.amount);
                    
                    if (exactMatch.frequency === 'fixed') {
                        document.getElementById('frequencyFixed').checked = true;
                    } else {
                        document.getElementById('frequencyVariable').checked = true;
                    }
                    
                    existingBillsList.style.display = 'none';
                });
                
                existingBillsList.appendChild(duplicateItem);
            }
            
            // Show other similar bills
            similarBills.forEach(bill => {
                if (exactMatch && bill.id === exactMatch.id) {
                    return; // Skip exact match, already shown
                }
                
                const billItem = document.createElement('div');
                billItem.className = 'existing-bill-item';
                billItem.innerHTML = `
                    <div class="existing-bill-name">${bill.name}</div>
                    <div class="existing-bill-details">
                        Due day ${bill.dueDay}  ${bill.frequency === 'fixed' ? 'Fixed amount' : 'Variable amount'}
                    </div>
                `;
                
                billItem.addEventListener('click', function() {
                    billNameInput.value = bill.name;
                    existingBillsList.style.display = 'none';
                });
                
                existingBillsList.appendChild(billItem);
            });
            
            existingBillsList.style.display = 'block';
        }

        // Render bill history screen
        function renderBillHistoryScreen() {
            const billHistory = DataModel.getBillPaymentHistory();
            
            if (billHistory.length === 0) {
                billHistoryContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p>No bill history yet</p>
                        <p class="text-very-muted mt-sm">Bill payment history will appear here</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            
            billHistory.forEach(bill => {
                historyHTML += `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <div class="bill-name">${bill.billName}</div>
                                <div class="bill-details">Due day ${bill.dueDay}</div>
                            </div>
                        </div>
                        <div class="history-months">
                `;
                
                bill.months.forEach(month => {
                    const monthClass = month.isCurrentMonth ? 'history-month-current' : '';
                    const amountClass = month.paid ? 'history-month-paid' : 'history-month-unpaid';
                    const statusText = month.paid ? 'Paid' : 'Not paid';
                    
                    historyHTML += `
                        <div class="history-month ${monthClass}">
                            <div class="history-month-name">${month.name}</div>
                            <div class="history-month-amount ${amountClass}">${formatNumber(month.amount)}</div>
                            <div class="text-very-muted" style="font-size: 11px; margin-top: 2px;">${statusText}</div>
                        </div>
                    `;
                });
                
                historyHTML += `
                        </div>
                    </div>
                `;
            });
            
            billHistoryContainer.innerHTML = historyHTML;
        }

        // =========================================================================
        // ACTIVITY SCREEN FUNCTIONS
        // =========================================================================

        // Render all activity screen
        function renderAllActivityScreen() {
            const movements = DataModel.getRecentMovements(50);
            
            if (movements.length === 0) {
                allActivityContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p>No activity yet</p>
                        <p class="text-very-muted mt-sm">Add or spend money to see activity here</p>
                    </div>
                `;
                return;
            }
            
            let activityHTML = '';
            
            // Group by date
            const groupedByDate = {};
            movements.forEach(movement => {
                const date = new Date(movement.date);
                const dateKey = date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(movement);
            });
            
            // Render by date groups
            Object.keys(groupedByDate).forEach(dateKey => {
                activityHTML += `<div class="section-title">${dateKey}</div>`;
                
                groupedByDate[dateKey].forEach(movement => {
                    const jar = DataModel.getJarById(movement.jarId);
                    const jarName = jar ? jar.name : 'Unknown jar';
                    const amountClass = movement.direction === 'in' ? 'activity-amount-in' : 'activity-amount-out';
                    const amountPrefix = movement.direction === 'in' ? '+' : '-';
                    
                    activityHTML += `
                        <div class="activity-item" data-movement-id="${movement.id}">
                            <div class="activity-description">
                                <div>${movement.description}</div>
                                <div class="activity-note">
                                    ${movement.note || ''}
                                    ${movement.note ? '  ' : ''}${jarName}
                                </div>
                                <div class="activity-date">${new Date(movement.date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                            </div>
                            <div class="${amountClass}">
                                ${amountPrefix}${formatNumber(movement.amount)}
                            </div>
                        </div>
                    `;
                });
            });
            
            allActivityContainer.innerHTML = activityHTML;
            
            // Add click handlers to activity items
            document.querySelectorAll('.activity-item[data-movement-id]').forEach(item => {
                item.addEventListener('click', function() {
                    const movementId = this.getAttribute('data-movement-id');
                    openEditTransactionModal(movementId);
                });
            });
        }

        // =========================================================================
        // RENDER FUNCTIONS
        // =========================================================================

        // Render the home screen
        function renderHomeScreen() {
            // Update total balance
            const totalBalance = DataModel.getTotalBalance();
            totalBalanceEl.textContent = formatNumber(totalBalance);
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const currentMonth = new Date().getMonth();
            currentMonthEl.textContent = monthNames[currentMonth];
            
            // Update status message
            const billsCovered = DataModel.areBillsCovered();
            statusMessageEl.textContent = billsCovered 
                ? 'Bills look covered ' 
                : 'Let\'s keep an eye on things.';
            
            // Check for nudge
            const nudgeMessage = DataModel.shouldShowNudge();
            if (nudgeMessage) {
                nudgeMessageEl.textContent = nudgeMessage;
                nudgeMessageEl.style.display = 'block';
                AppState.lastNudgeDate = new Date().toISOString();
            } else {
                nudgeMessageEl.style.display = 'none';
            }
            
            // Render jars
            renderJars();
        }

        // Render the jar cards
        function renderJars() {
            jarsContainerEl.innerHTML = '';
            
            DataModel.jars.forEach(jar => {
                const jarCard = document.createElement('div');
                jarCard.className = 'card jar-card';
                jarCard.setAttribute('data-jar-id', jar.id);
                
                jarCard.innerHTML = `
                    <div class="jar-card-info">
                        <h3>${jar.name}</h3>
                        <div class="text-muted">You have</div>
                    </div>
                    <div class="jar-card-amount">${formatNumber(jar.amount)}</div>
                `;
                
                jarCard.addEventListener('click', () => {
                    AppState.currentJarId = jar.id;
                    renderJarDetailScreen();
                    showScreen('jarDetailScreen');
                });
                
                jarsContainerEl.appendChild(jarCard);
            });
        }

        // Render the jar detail screen
        function renderJarDetailScreen() {
            const jar = DataModel.getJarById(AppState.currentJarId);
            if (!jar) return;
            
            // Update header and balance
            document.getElementById('jarDetailName').textContent = jar.name;
            document.getElementById('jarDetailBalance').textContent = formatNumber(jar.amount);
            
            // Render activity list
            const activityListEl = document.getElementById('jarActivityList');
            const movements = DataModel.getMovementsForJar(jar.id);
            
            if (movements.length === 0) {
                activityListEl.innerHTML = `
                    <h3>Recent activity</h3>
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p>No activity yet</p>
                    </div>
                `;
            } else {
                let activityHTML = '<h3>Recent activity</h3>';
                
                movements.forEach(movement => {
                    const amountClass = movement.direction === 'in' ? 'activity-amount-in' : 'activity-amount-out';
                    const amountPrefix = movement.direction === 'in' ? '+' : '-';
                    
                    activityHTML += `
                        <div class="activity-item" data-movement-id="${movement.id}">
                            <div class="activity-description">
                                <div>${movement.description}</div>
                                ${movement.note ? `<div class="activity-note">${movement.note}</div>` : ''}
                                <div class="activity-date">${formatDate(movement.date)}</div>
                            </div>
                            <div class="${amountClass}">
                                ${amountPrefix}${formatNumber(movement.amount)}
                            </div>
                        </div>
                    `;
                });
                
                activityListEl.innerHTML = activityHTML;
                
                // Add click handlers to activity items
                document.querySelectorAll('.activity-item[data-movement-id]').forEach(item => {
                    item.addEventListener('click', function() {
                        const movementId = this.getAttribute('data-movement-id');
                        openEditTransactionModal(movementId);
                    });
                });
            }
            
            // Set up button event handlers
            document.getElementById('addToJarBtn').onclick = () => {
                // Pre-select the current jar in the add money form
                const jarSelect = document.getElementById('addMoneyJar');
                if (jarSelect) {
                    jarSelect.value = jar.id;
                }
                showScreen('addMoneyScreen');
            };
            
            document.getElementById('spendFromJarBtn').onclick = () => {
                // Pre-select the current jar in the spend money form
                const jarSelect = document.getElementById('spendMoneyJar');
                if (jarSelect) {
                    jarSelect.value = jar.id;
                }
                showScreen('spendMoneyScreen');
            };
        }

        // Render the bills screen
        function renderBillsScreen() {
            const { upcoming, paid } = DataModel.getBillsForCurrentMonth();
            const upcomingBillsEl = document.getElementById('upcomingBills');
            const paidBillsEl = document.getElementById('paidBills');
            
            // Render upcoming bills
            if (upcoming.length === 0) {
                upcomingBillsEl.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><p>No bills coming up</p></div>';
            } else {
                upcomingBillsEl.innerHTML = '';
                
                upcoming.forEach(bill => {
                    const billItem = document.createElement('div');
                    billItem.className = 'card bill-item';
                    billItem.setAttribute('data-bill-id', bill.id);
                    
                    const dueText = bill.daysUntilDue === 0 ? 'Due today' : 
                                   bill.daysUntilDue === 1 ? 'Due tomorrow' : 
                                   bill.daysUntilDue < 0 ? `Overdue by ${Math.abs(bill.daysUntilDue)} days` : 
                                   `Due in ${bill.daysUntilDue} days`;
                    
                    billItem.innerHTML = `
                        <div class="bill-info">
                            <div class="bill-name">${bill.name}</div>
                            <div class="bill-details">${dueText}  Day ${bill.dueDay}</div>
                        </div>
                        <div class="bill-amount">${formatNumber(bill.amount)}</div>
                    `;
                    
                    // Add click handler to mark as paid
                    billItem.addEventListener('click', () => {
                        AppState.currentBillId = bill.id;
                        
                        if (bill.frequency === 'variable') {
                            // For variable bills, prompt for amount
                            const amount = prompt(`How much was ${bill.name} this month?`, bill.lastAmount || bill.amount);
                            if (amount && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) {
                                DataModel.markBillAsPaid(bill.id, parseFloat(amount));
                                showSuccessMessage('Bill marked as paid ');
                                renderBillsScreen();
                            }
                        } else {
                            // For fixed bills, just mark as paid
                            DataModel.markBillAsPaid(bill.id);
                            showSuccessMessage('Bill marked as paid ');
                            renderBillsScreen();
                        }
                    });
                    
                    upcomingBillsEl.appendChild(billItem);
                });
            }
            
            // Render paid bills
            if (paid.length === 0) {
                paidBillsEl.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><p>No bills paid yet</p></div>';
            } else {
                paidBillsEl.innerHTML = '';
                
                paid.forEach(bill => {
                    const billItem = document.createElement('div');
                    billItem.className = 'card bill-item bill-paid';
                    
                    billItem.innerHTML = `
                        <div class="bill-info">
                            <div class="bill-name">${bill.name}</div>
                            <div class="bill-details">Paid  Day ${bill.dueDay}</div>
                        </div>
                        <div class="bill-amount">${formatNumber(bill.amount)}</div>
                    `;
                    
                    paidBillsEl.appendChild(billItem);
                });
            }
        }

        // Populate category radio buttons
        function populateCategories() {
            const categoryGroup = document.getElementById('spendCategoryGroup');
            categoryGroup.innerHTML = '';
            
            AppState.categories.forEach(category => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'radio-option';
                
                const inputId = `category-${category.toLowerCase().replace(' ', '-')}`;
                
                optionDiv.innerHTML = `
                    <input type="radio" id="${inputId}" name="category" value="${category}" class="radio-input" ${category === 'Something else' ? 'checked' : ''}>
                    <label for="${inputId}" class="radio-label">${category}</label>
                `;
                
                categoryGroup.appendChild(optionDiv);
            });
        }

        // =========================================================================
        // EVENT HANDLERS AND FORM SUBMISSIONS
        // =========================================================================

        // Handle add money form submission
        addMoneyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = document.getElementById('addMoneyAmount').value;
            const jarId = document.getElementById('addMoneyJar').value;
            const source = document.getElementById('addMoneySource').value;
            
            if (!amount || parseFloat(amount) <= 0 || !jarId) {
                return;
            }
            
            // Add the movement
            DataModel.addMovement(
                parseFloat(amount), 
                'in', 
                jarId, 
                'Money came in', 
                source || undefined
            );
            
            // Show success message
            showSuccessMessage('Money added ');
            
            // Reset form
            addMoneyForm.reset();
            
            // Return to home screen
            showScreen('homeScreen');
        });

        // Handle spend money form submission
        spendMoneyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = document.getElementById('spendMoneyAmount').value;
            const jarId = document.getElementById('spendMoneyJar').value;
            const category = document.querySelector('input[name="category"]:checked').value;
            
            if (!amount || parseFloat(amount) <= 0 || !jarId) {
                return;
            }
            
            // Check if jar has enough money
            const jar = DataModel.getJarById(jarId);
            if (jar && jar.amount < parseFloat(amount)) {
                // Still allow spending, even if it goes negative
                // This is intentional per requirements
            }
            
            // Add the movement
            DataModel.addMovement(
                parseFloat(amount), 
                'out', 
                jarId, 
                category, 
                'Money went out'
            );
            
            // Show success message
            showSuccessMessage('Money spent');
            
            // Reset form
            spendMoneyForm.reset();
            
            // Return to home screen
            showScreen('homeScreen');
        });

        // Handle add bill form submission
        addBillForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('billName').value.trim();
            const frequency = document.querySelector('input[name="frequency"]:checked').value;
            const amount = document.getElementById('billAmount').value;
            const dueDay = document.getElementById('billDueDay').value;
            
            if (!name || !amount || parseFloat(amount) <= 0 || !dueDay || dueDay < 1 || dueDay > 31) {
                return;
            }
            
            // Check for exact duplicate
            const exactDuplicate = DataModel.bills.find(bill => 
                bill.name.toLowerCase() === name.toLowerCase()
            );
            
            if (exactDuplicate) {
                // Don't block, but show gentle message
                showSuccessMessage('Bill already exists');
                return;
            }
            
            // Add the bill
            DataModel.addBill(name, frequency, parseFloat(amount), parseInt(dueDay));
            
            // Show success message
            showSuccessMessage('Bill added');
            
            // Reset form
            addBillForm.reset();
            
            // Hide existing bills list
            existingBillsList.style.display = 'none';
            
            // Return to bills screen
            renderBillsScreen();
            showScreen('billsScreen');
        });

        // Handle bill name input for showing existing bills
        billNameInput.addEventListener('input', function() {
            showExistingBillsSuggestions(this.value);
        });

        // Handle clicking outside to hide suggestions
        document.addEventListener('click', function(e) {
            if (!billNameInput.contains(e.target) && !existingBillsList.contains(e.target)) {
                existingBillsList.style.display = 'none';
            }
        });

        // Handle view bill history button
        viewBillHistoryBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showScreen('billHistoryScreen');
        });

        // Handle back to bills button
        backToBillsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showScreen('billsScreen');
        });

        // Handle view all activity button
        viewAllActivityBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showScreen('allActivityScreen');
        });

        // Handle back to home from activity button
        backToHomeFromActivityBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showScreen('homeScreen');
        });

        // Handle add bill button click
        document.getElementById('addBillBtn').addEventListener('click', function() {
            // Reset the form
            addBillForm.reset();
            
            // Set default values
            document.getElementById('frequencyFixed').checked = true;
            
            // Update title
            document.getElementById('addBillTitle').textContent = 'Add a bill';
            
            // Clear existing bills list
            existingBillsList.style.display = 'none';
            existingBillsList.innerHTML = '';
            
            // Show the add bill screen
            showScreen('addBillScreen');
        });

        // =========================================================================
        // NAVIGATION AND INITIALIZATION
        // =========================================================================

        // Set up navigation
        document.querySelectorAll('.nav-item').forEach(navItem => {
            navItem.addEventListener('click', function(e) {
                e.preventDefault();
                const screenId = this.getAttribute('data-screen');
                showScreen(screenId);
            });
        });

        // Set up back button behavior (simulated with logo click)
        document.querySelector('.app-header h1').addEventListener('click', function() {
            if (AppState.currentScreen !== 'homeScreen') {
                showScreen('homeScreen');
            }
        });

        // Initialize the app
        function initApp() {
            // Initialize data model
            DataModel.init();
            
            // Populate dynamic form elements
            populateJarSelects();
            populateCategories();
            
            // Set current month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const currentMonth = new Date().getMonth();
            currentMonthEl.textContent = monthNames[currentMonth];
            
            // Check if we need to reset bill payments for new month
            const appState = DataModel.appState;
            const currentDate = new Date();
            const currentMonthNow = currentDate.getMonth();
            const currentYearNow = currentDate.getFullYear();
            
            if (appState.currentMonth !== currentMonthNow || appState.currentYear !== currentYearNow) {
                // Reset all bill payments for the new month
                DataModel.bills.forEach(bill => {
                    bill.lastPaidMonth = null;
                    bill.lastPaidYear = null;
                });
                appState.currentMonth = currentMonthNow;
                appState.currentYear = currentYearNow;
                DataModel.saveToStorage();
            }
            
            // Render initial screen
            renderHomeScreen();
            
            // Show home screen by default
            showScreen('homeScreen');
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>