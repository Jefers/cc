<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Clipper | Browser-Based Video Editing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --accent-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --danger-color: #f94144;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        h1 i {
            color: var(--secondary-color);
        }

        .subtitle {
            color: var(--gray-color);
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .app-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .app-wrapper {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.3rem;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }

        .card-title i {
            font-size: 1.2rem;
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed var(--gray-color);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.03);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .upload-area h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .upload-area p {
            color: var(--gray-color);
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background-color: var(--primary-dark);
        }

        .file-info {
            display: none;
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }

        .file-info.active {
            display: block;
        }

        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .file-details {
            display: flex;
            justify-content: space-between;
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* Video Player */
        .video-container {
            width: 100%;
            margin-bottom: 20px;
        }

        video {
            width: 100%;
            border-radius: var(--border-radius);
            background-color: black;
        }

        .video-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            background-color: var(--dark-color);
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }

        .play-pause-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .play-pause-btn:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Clip Selection */
        .clip-markers {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 20px;
        }

        .marker {
            flex: 1;
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .marker.start {
            border-left: 4px solid var(--success-color);
        }

        .marker.end {
            border-left: 4px solid var(--danger-color);
        }

        .marker-label {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .marker-time {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .marker-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .marker-btn {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .marker-btn.start {
            background-color: var(--success-color);
            color: white;
        }

        .marker-btn.end {
            background-color: var(--danger-color);
            color: white;
        }

        .marker-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .clip-range-display {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
        }

        .clip-range-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .clip-range-bar {
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .clip-range-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--accent-color));
            border-radius: 5px;
            position: absolute;
        }

        .clip-range-times {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        /* Processing Section */
        .processing-section {
            text-align: center;
        }

        .cut-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            justify-content: center;
        }

        .cut-btn:hover:not(:disabled) {
            background-color: #5a0c9c;
            transform: translateY(-3px);
        }

        .cut-btn:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            height: 20px;
            background-color: var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: var(--border-radius);
            display: none;
        }

        .status-message.active {
            display: block;
        }

        .status-message.success {
            background-color: rgba(76, 201, 240, 0.2);
            color: #0a7c9c;
            border-left: 4px solid var(--success-color);
        }

        .status-message.error {
            background-color: rgba(249, 65, 68, 0.2);
            color: #c21f1f;
            border-left: 4px solid var(--danger-color);
        }

        .status-message.info {
            background-color: rgba(67, 97, 238, 0.2);
            color: var(--primary-dark);
            border-left: 4px solid var(--primary-color);
        }

        .status-message.warning {
            background-color: rgba(248, 150, 30, 0.2);
            color: #b36a00;
            border-left: 4px solid var(--warning-color);
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray-color);
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .instructions {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-top: 30px;
        }

        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .step {
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
        
        /* Quality settings */
        .quality-settings {
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--warning-color);
        }
        
        .quality-settings h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--warning-color);
            margin-bottom: 10px;
        }
        
        .quality-settings p {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .quality-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .quality-option {
            padding: 12px;
            border-radius: var(--border-radius);
            border: 2px solid var(--light-gray);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .quality-option:hover {
            border-color: var(--primary-color);
        }
        
        .quality-option.active {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .quality-option i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .quality-option span {
            font-weight: 500;
        }
        
        .quality-desc {
            font-size: 0.85rem;
            color: var(--gray-color);
            text-align: center;
        }
        
        /* Browser compatibility warning */
        .browser-warning {
            background-color: rgba(248, 150, 30, 0.2);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .browser-warning i {
            font-size: 1.5rem;
            color: var(--warning-color);
            flex-shrink: 0;
        }
        
        .browser-warning p {
            margin: 0;
            color: var(--dark-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-scissors"></i> Browser Video Clipper</h1>
            <p class="subtitle">A self-contained video clipping tool that runs entirely in your browser. Upload a video, select a clip, and download the trimmed version â€” all locally on your Mac.</p>
        </header>

        <div class="browser-warning" id="browserWarning">
            <i class="fas fa-info-circle"></i>
            <p><strong>Note:</strong> For best results, use Chrome or Edge. Safari has limited support for certain video formats in MediaRecorder. The app works best with MP4 files under 2GB.</p>
        </div>

        <div class="app-wrapper">
            <!-- Left Column: Video Upload & Player -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-video"></i>
                    <h2>Video Upload & Player</h2>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Upload Your Video</h3>
                    <p>Drag & drop or click to browse for .mov or .mp4 files</p>
                    <button class="upload-btn" id="uploadBtn">
                        <i class="fas fa-folder-open"></i> Choose Video File
                    </button>
                    <input type="file" id="videoFile" class="file-input" accept=".mov,.mp4,.MOV,.MP4">
                </div>
                
                <div class="file-info" id="fileInfo">
                    <div class="file-name" id="fileName">No file selected</div>
                    <div class="file-details">
                        <span id="fileSize">0 MB</span>
                        <span id="fileDuration">Duration: 0:00</span>
                    </div>
                </div>
                
                <div class="video-container">
                    <video id="videoPlayer" controls>
                        Your browser does not support the video tag.
                    </video>
                    
                    <div class="video-controls">
                        <button class="play-pause-btn" id="playPauseBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="time-display">
                            <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Clip Selection & Processing -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-cut"></i>
                    <h2>Clip Selection & Processing</h2>
                </div>
                
                <div class="clip-markers">
                    <div class="marker start">
                        <div class="marker-label">START MARKER</div>
                        <div class="marker-time" id="startTime">0:00</div>
                        <div class="marker-controls">
                            <button class="marker-btn start" id="setStartBtn">
                                <i class="fas fa-flag"></i> Set Start
                            </button>
                        </div>
                    </div>
                    
                    <div class="marker end">
                        <div class="marker-label">END MARKER</div>
                        <div class="marker-time" id="endTime">0:00</div>
                        <div class="marker-controls">
                            <button class="marker-btn end" id="setEndBtn">
                                <i class="fas fa-flag-checkered"></i> Set End
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="clip-range-display">
                    <div class="clip-range-title">
                        <i class="fas fa-ruler-combined"></i>
                        <span>Selected Clip Range</span>
                    </div>
                    <div class="clip-range-bar">
                        <div class="clip-range-fill" id="clipRangeFill"></div>
                    </div>
                    <div class="clip-range-times">
                        <span id="clipStartDisplay">0:00</span>
                        <span id="clipDurationDisplay">Duration: 0:00</span>
                        <span id="clipEndDisplay">0:00</span>
                    </div>
                </div>
                
                <div class="quality-settings">
                    <h4><i class="fas fa-sliders-h"></i> Output Quality Settings</h4>
                    <p>Select the quality for your clipped video. Higher quality produces larger files.</p>
                    <div class="quality-options" id="qualityOptions">
                        <div class="quality-option active" data-quality="high">
                            <i class="fas fa-hd"></i>
                            <span>High Quality</span>
                            <span class="quality-desc">Best for HD videos</span>
                        </div>
                        <div class="quality-option" data-quality="medium">
                            <i class="fas fa-balance-scale"></i>
                            <span>Medium Quality</span>
                            <span class="quality-desc">Good balance</span>
                        </div>
                        <div class="quality-option" data-quality="low">
                            <i class="fas fa-compress-alt"></i>
                            <span>Low Quality</span>
                            <span class="quality-desc">Smaller file size</span>
                        </div>
                    </div>
                </div>
                
                <div class="processing-section">
                    <button class="cut-btn" id="cutBtn" disabled>
                        <i class="fas fa-cut"></i> Cut & Download Video Clip
                    </button>
                    
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressStatus">Initializing...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                    </div>
                    
                    <div class="status-message" id="statusMessage"></div>
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> How to Use This Tool</h3>
            <div class="steps">
                <div class="step">
                    <span class="step-number">1</span> Upload a .mov or .mp4 video file using the upload area.
                </div>
                <div class="step">
                    <span class="step-number">2</span> Play the video and use "Set Start" and "Set End" buttons to define your clip.
                </div>
                <div class="step">
                    <span class="step-number">3</span> Select output quality (High, Medium, or Low) based on your needs.
                </div>
                <div class="step">
                    <span class="step-number">4</span> Click "Cut & Download" and wait for processing to complete.
                </div>
            </div>
        </div>
        
        <footer>
            <p>Browser Video Clipper | A self-contained HTML application using browser APIs | Runs entirely in your browser</p>
            <p>Compatible with macOS Chrome, Firefox, and Safari | No data leaves your computer | No external dependencies</p>
        </footer>
    </div>

    <script>
        // Global variables
        let videoElement = null;
        let videoFile = null;
        let startTime = 0;
        let endTime = 0;
        let videoDuration = 0;
        let isPlaying = false;
        let selectedQuality = 'medium'; // high, medium, low

        // DOM elements
        const videoFileInput = document.getElementById('videoFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadArea = document.getElementById('uploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileDuration = document.getElementById('fileDuration');
        const videoPlayer = document.getElementById('videoPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const setStartBtn = document.getElementById('setStartBtn');
        const setEndBtn = document.getElementById('setEndBtn');
        const startTimeEl = document.getElementById('startTime');
        const endTimeEl = document.getElementById('endTime');
        const cutBtn = document.getElementById('cutBtn');
        const clipStartDisplay = document.getElementById('clipStartDisplay');
        const clipEndDisplay = document.getElementById('clipEndDisplay');
        const clipDurationDisplay = document.getElementById('clipDurationDisplay');
        const clipRangeFill = document.getElementById('clipRangeFill');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');
        const progressPercent = document.getElementById('progressPercent');
        const statusMessage = document.getElementById('statusMessage');
        const qualityOptions = document.getElementById('qualityOptions');
        const browserWarning = document.getElementById('browserWarning');

        // Check browser compatibility
        function checkBrowserCompatibility() {
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isSafari || isIOS) {
                browserWarning.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <p><strong>Browser Compatibility Note:</strong> You're using Safari which has limited support for video processing. 
                        The app will work best with MP4 files. For best results, consider using Chrome or Firefox on macOS.</p>
                        <p style="margin-top: 5px; font-size: 0.9em;">If you encounter issues, try converting your video to MP4 format first.</p>
                    </div>
                `;
            }
            
            // Check for MediaRecorder support
            if (typeof MediaRecorder === 'undefined' || !MediaRecorder.isTypeSupported) {
                browserWarning.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <p><strong>Warning:</strong> Your browser doesn't fully support video recording features. 
                    Consider updating to the latest version of Chrome, Firefox, or Edge for best results.</p>
                `;
            }
        }

        // Format time in seconds to MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // Format time in seconds to HH:MM:SS
        function formatTimeLong(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
            } else {
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        // Update video time display
        function updateTimeDisplay() {
            if (!videoPlayer.duration) return;
            
            const currentTime = videoPlayer.currentTime;
            currentTimeEl.textContent = formatTime(currentTime);
            durationEl.textContent = formatTime(videoPlayer.duration);
            
            // Update the clip range visualization
            updateClipVisualization();
        }

        // Update clip visualization
        function updateClipVisualization() {
            if (videoDuration === 0) return;
            
            const startPercent = (startTime / videoDuration) * 100;
            const endPercent = (endTime / videoDuration) * 100;
            const widthPercent = endTime > startTime ? endPercent - startPercent : 0;
            
            clipRangeFill.style.width = `${widthPercent}%`;
            clipRangeFill.style.left = `${startPercent}%`;
            
            clipStartDisplay.textContent = formatTime(startTime);
            clipEndDisplay.textContent = formatTime(endTime);
            
            const clipDuration = endTime - startTime;
            clipDurationDisplay.textContent = `Duration: ${formatTime(clipDuration)}`;
            
            // Update the cut button state
            cutBtn.disabled = !(endTime > startTime && endTime > 0 && videoFile);
        }

        // Set start marker at current video time
        function setStartMarker() {
            if (!videoPlayer.duration) {
                showStatus('Please load a video first', 'error');
                return;
            }
            
            startTime = videoPlayer.currentTime;
            
            // Ensure start time is less than end time
            if (startTime >= endTime) {
                endTime = Math.min(startTime + 5, videoDuration);
            }
            
            startTimeEl.textContent = formatTime(startTime);
            updateClipVisualization();
            showStatus(`Start marker set to ${formatTimeLong(startTime)}`, 'success');
        }

        // Set end marker at current video time
        function setEndMarker() {
            if (!videoPlayer.duration) {
                showStatus('Please load a video first', 'error');
                return;
            }
            
            endTime = videoPlayer.currentTime;
            
            // Ensure end time is greater than start time
            if (endTime <= startTime) {
                startTime = Math.max(endTime - 5, 0);
            }
            
            endTimeEl.textContent = formatTime(endTime);
            updateClipVisualization();
            showStatus(`End marker set to ${formatTimeLong(endTime)}`, 'success');
        }

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message active ${type}`;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.classList.remove('active');
                }, 5000);
            }
        }

        // Handle video file upload
        function handleFileUpload(file) {
            if (!file.type.match('video.*') && !file.name.match(/\.(mp4|mov|MP4|MOV|webm|WEBM)$/)) {
                showStatus('Please select a video file (MP4, MOV, or WebM)', 'error');
                return;
            }
            
            // Check file size (limit to 2GB for browser memory constraints)
            const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
            if (file.size > maxSize) {
                showStatus('File is too large. Please select a video under 2GB.', 'error');
                return;
            }
            
            videoFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = `${(file.size / (1024 * 1024)).toFixed(2)} MB`;
            
            // Create a URL for the video file
            const videoURL = URL.createObjectURL(file);
            videoPlayer.src = videoURL;
            
            // Reset markers
            startTime = 0;
            endTime = 0;
            startTimeEl.textContent = '0:00';
            endTimeEl.textContent = '0:00';
            
            // Show file info
            fileInfo.classList.add('active');
            
            // Enable marker buttons
            setStartBtn.disabled = false;
            setEndBtn.disabled = false;
            
            showStatus(`Video "${file.name}" loaded successfully`, 'success');
        }

        // Get quality settings based on selection
        function getQualitySettings(quality) {
            const settings = {
                high: {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 5000000, // 5 Mbps
                    label: 'High Quality (WebM/VP9)',
                    extension: 'webm'
                },
                medium: {
                    mimeType: 'video/webm;codecs=vp8',
                    videoBitsPerSecond: 2500000, // 2.5 Mbps
                    label: 'Medium Quality (WebM/VP8)',
                    extension: 'webm'
                },
                low: {
                    mimeType: 'video/webm;codecs=vp8',
                    videoBitsPerSecond: 1000000, // 1 Mbps
                    label: 'Low Quality (WebM/VP8)',
                    extension: 'webm'
                }
            };
            
            // Check browser support for the mimeType
            const supportedType = MediaRecorder.isTypeSupported ? 
                MediaRecorder.isTypeSupported(settings[quality].mimeType) : true;
            
            if (!supportedType && quality === 'high') {
                // Fall back to VP8 if VP9 not supported
                settings.high.mimeType = 'video/webm;codecs=vp8';
            }
            
            return settings[quality];
        }

        // Process and cut the video using Canvas and MediaRecorder
        async function cutVideo() {
            // Validate clip range
            if (endTime <= startTime) {
                showStatus('Invalid clip range. End time must be after start time.', 'error');
                return;
            }
            
            const clipDuration = endTime - startTime;
            
            // Check if clip is too long (limit to 10 minutes for performance)
            const maxClipDuration = 10 * 60; // 10 minutes in seconds
            if (clipDuration > maxClipDuration) {
                showStatus(`Clip is too long. Maximum clip duration is ${formatTime(maxClipDuration)}.`, 'error');
                return;
            }
            
            // Show progress
            progressContainer.classList.add('active');
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressStatus.textContent = 'Preparing video processing...';
            cutBtn.disabled = true;
            
            try {
                // Get quality settings
                const qualitySettings = getQualitySettings(selectedQuality);
                showStatus(`Processing with ${qualitySettings.label}`, 'info');
                
                // Create an offscreen video element
                const processingVideo = document.createElement('video');
                processingVideo.muted = true; // Mute to avoid audio issues with autoplay
                
                // Load the video file
                const videoURL = URL.createObjectURL(videoFile);
                processingVideo.src = videoURL;
                
                // Wait for video to load metadata
                await new Promise((resolve, reject) => {
                    processingVideo.onloadedmetadata = resolve;
                    processingVideo.onerror = () => reject(new Error('Failed to load video for processing'));
                    
                    // Set a timeout in case video fails to load
                    setTimeout(() => {
                        if (!processingVideo.videoWidth) {
                            reject(new Error('Video took too long to load'));
                        }
                    }, 10000);
                });
                
                progressFill.style.width = '20%';
                progressPercent.textContent = '20%';
                progressStatus.textContent = 'Video loaded, setting up recorder...';
                
                // Set video to start time
                processingVideo.currentTime = startTime;
                
                // Wait for video to seek to the start time
                await new Promise((resolve) => {
                    processingVideo.onseeked = resolve;
                    setTimeout(resolve, 1000); // Fallback timeout
                });
                
                // Create canvas for drawing video frames
                const canvas = document.createElement('canvas');
                canvas.width = processingVideo.videoWidth;
                canvas.height = processingVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                
                // Create a stream from the canvas
                const stream = canvas.captureStream(30); // 30 FPS
                
                // Check if we can also capture audio
                let audioStream = null;
                try {
                    // Create an audio context to process audio
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaElementSource(processingVideo);
                    const destination = audioContext.createMediaStreamDestination();
                    source.connect(destination);
                    audioStream = destination.stream;
                    
                    // Combine video and audio streams if available
                    if (audioStream) {
                        const audioTrack = audioStream.getAudioTracks()[0];
                        if (audioTrack) {
                            stream.addTrack(audioTrack);
                        }
                    }
                } catch (audioError) {
                    console.warn('Audio processing not available:', audioError);
                    showStatus('Note: Audio may not be included in the output', 'warning');
                }
                
                // Create MediaRecorder
                let mediaRecorder;
                try {
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: qualitySettings.mimeType,
                        videoBitsPerSecond: qualitySettings.videoBitsPerSecond
                    });
                } catch (recorderError) {
                    console.warn('Failed to create MediaRecorder with preferred settings:', recorderError);
                    
                    // Try with default settings
                    mediaRecorder = new MediaRecorder(stream);
                }
                
                const chunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                        
                        // Update progress based on data received
                        const progress = 20 + (chunks.length / 10) * 70; // Estimate
                        progressFill.style.width = `${Math.min(90, progress)}%`;
                        progressPercent.textContent = `${Math.min(90, Math.round(progress))}%`;
                    }
                };
                
                mediaRecorder.onstop = () => {
                    // Combine chunks and create download
                    const blob = new Blob(chunks, { type: mediaRecorder.mimeType || 'video/webm' });
                    
                    // Generate filename with timestamp
                    const now = new Date();
                    const timestamp = now.toISOString()
                        .replace(/[:]/g, '.')
                        .split('.')[0]
                        .replace('T', ' at ');
                    const outputFilename = `clip-${timestamp}.${qualitySettings.extension}`;
                    
                    // Create download link
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = outputFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl);
                    URL.revokeObjectURL(videoURL);
                    
                    // Clean up
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Update UI
                    progressFill.style.width = '100%';
                    progressPercent.textContent = '100%';
                    progressStatus.textContent = 'Clip downloaded successfully!';
                    
                    showStatus(`Video clip saved as "${outputFilename}"`, 'success');
                    
                    // Reset progress bar after a delay
                    setTimeout(() => {
                        progressContainer.classList.remove('active');
                        cutBtn.disabled = false;
                    }, 2000);
                };
                
                mediaRecorder.onerror = (error) => {
                    console.error('MediaRecorder error:', error);
                    showStatus(`Recording error: ${error.message || 'Unknown error'}`, 'error');
                    progressContainer.classList.remove('active');
                    cutBtn.disabled = false;
                    URL.revokeObjectURL(videoURL);
                };
                
                // Start recording
                mediaRecorder.start(1000); // Collect data every second
                
                progressFill.style.width = '30%';
                progressPercent.textContent = '30%';
                progressStatus.textContent = 'Processing video frames...';
                
                // Draw video frames to canvas for the clip duration
                const startTimeMs = Date.now();
                const endTimeMs = startTimeMs + (clipDuration * 1000);
                let lastFrameTime = 0;
                const frameInterval = 1000 / 30; // 30 FPS
                
                function drawFrame(timestamp) {
                    // Calculate elapsed time
                    const elapsed = Date.now() - startTimeMs;
                    const elapsedSeconds = elapsed / 1000;
                    
                    // Stop if we've reached the end
                    if (elapsed >= clipDuration * 1000) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    // Throttle frame drawing to ~30 FPS
                    if (timestamp - lastFrameTime >= frameInterval) {
                        // Draw current video frame to canvas
                        ctx.drawImage(processingVideo, 0, 0, canvas.width, canvas.height);
                        
                        // Update video time based on elapsed time
                        const targetTime = startTime + elapsedSeconds;
                        if (Math.abs(processingVideo.currentTime - targetTime) > 0.1) {
                            processingVideo.currentTime = targetTime;
                        }
                        
                        lastFrameTime = timestamp;
                        
                        // Update progress
                        const progress = 30 + (elapsedSeconds / clipDuration) * 60;
                        progressFill.style.width = `${Math.min(90, progress)}%`;
                        progressPercent.textContent = `${Math.min(90, Math.round(progress))}%`;
                        progressStatus.textContent = `Processing: ${formatTime(elapsedSeconds)}/${formatTime(clipDuration)}`;
                    }
                    
                    // Continue processing
                    requestAnimationFrame(drawFrame);
                }
                
                // Start drawing frames
                processingVideo.play().catch(e => {
                    console.warn('Autoplay prevented, continuing without playback:', e);
                });
                
                requestAnimationFrame(drawFrame);
                
                // Set a timeout to stop recording in case something goes wrong
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, (clipDuration * 1000) + 5000); // Extra 5 seconds buffer
                
            } catch (error) {
                console.error('Video processing failed:', error);
                showStatus(`Processing failed: ${error.message}`, 'error');
                progressContainer.classList.remove('active');
                cutBtn.disabled = false;
                
                // Clean up any URLs
                const elements = document.querySelectorAll('video');
                elements.forEach(el => {
                    if (el.src && el.src.startsWith('blob:')) {
                        URL.revokeObjectURL(el.src);
                    }
                });
            }
        }

        // Initialize the application
        function initApp() {
            // Check browser compatibility
            checkBrowserCompatibility();
            
            // Set up event listeners
            
            // File upload via button
            uploadBtn.addEventListener('click', () => {
                videoFileInput.click();
            });
            
            // File upload via drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
                uploadArea.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            // File input change
            videoFileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // Video player events
            videoPlayer.addEventListener('loadedmetadata', () => {
                videoDuration = videoPlayer.duration;
                durationEl.textContent = formatTime(videoDuration);
                fileDuration.textContent = `Duration: ${formatTimeLong(videoDuration)}`;
                endTime = videoDuration;
                endTimeEl.textContent = formatTime(videoDuration);
                updateClipVisualization();
            });
            
            videoPlayer.addEventListener('timeupdate', updateTimeDisplay);
            
            videoPlayer.addEventListener('play', () => {
                isPlaying = true;
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            });
            
            videoPlayer.addEventListener('pause', () => {
                isPlaying = false;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            });
            
            // Play/pause button
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) {
                    videoPlayer.pause();
                } else {
                    videoPlayer.play();
                }
            });
            
            // Marker buttons
            setStartBtn.addEventListener('click', setStartMarker);
            setEndBtn.addEventListener('click', setEndMarker);
            
            // Cut button
            cutBtn.addEventListener('click', cutVideo);
            
            // Quality selection
            qualityOptions.querySelectorAll('.quality-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove active class from all options
                    qualityOptions.querySelectorAll('.quality-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    
                    // Add active class to clicked option
                    option.classList.add('active');
                    
                    // Update selected quality
                    selectedQuality = option.dataset.quality;
                    
                    showStatus(`Output quality set to: ${option.querySelector('span').textContent}`, 'info');
                });
            });
            
            // Initialize with sample values
            updateClipVisualization();
            
            // Show welcome message
            showStatus('Upload a video file to get started. Supported formats: MP4, MOV, and WebM.', 'info');
            
            // Add a test video option for demo purposes
            // This would be for development only, remove in production
            if (window.location.href.includes('localhost') || window.location.href.includes('127.0.0.1')) {
                console.log('Development mode: Test features enabled');
            }
        }

        // Start the app when the page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>