<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weight Tracker | Coach Christian</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Additional styling specific to the weight tracker page */
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .warning {
      color: #e74c3c;
      border-left: 3px solid #e74c3c;
      padding: 0.5rem;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    #graphContainer {
      width: 100%;
      height: 300px;
      position: relative;
      border: 1px solid #ccc;
      margin-top: 20px;
    }
    /* Spinner for Save Plan button */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.6);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Responsive adjustments for table and graph */
    @media (min-width: 768px) {
      table { font-size: 16px; }
    }
  </style>
</head>
<body>
  <!-- Fixed Header (using global styles from styles.css) -->
  <header class="fixed-header">
    <div class="header-left">
      <div class="logo">
        <!-- Replace with your logo if desired -->
        Logo
      </div>
      <div class="site-title">CoachChristian</div>
    </div>
    <a href="menu.html" class="hamburger">&#9776;</a>
  </header>
  
  <div class="content">
    <section class="section">
      <h2>Weight Tracking Plan</h2>
      <p>Enter your plan details below. All inputs are validated in real‑time and your plan will be saved (in a 45‑day cookie) and displayed as a weekly table and a simple graph. You can also update your actual weight each week and see your progress plotted in orange.</p>
      
      <form id="planForm">
        <div class="form-group">
          <label for="startDate">Start Date (future date):</label>
          <input type="date" id="startDate" required>
        </div>
        <div class="form-group">
          <label for="currentWeight">Current Weight (lbs, min 100):</label>
          <input type="number" id="currentWeight" min="100" required>
        </div>
        <div class="form-group">
          <label for="targetWeight">Target Weight (lbs, min 50):</label>
          <input type="number" id="targetWeight" min="50" required>
        </div>
        <div id="warningMessage"></div>
        <div class="center-button" style="margin-top:20px;">
          <button type="button" id="savePlanBtn" onclick="savePlan()">Save Plan <span id="spinner" class="spinner" style="display:none;"></span></button>
        </div>
      </form>
      
      <!-- This section appears after a plan is saved -->
      <div id="planDisplay" style="display:none;">
        <h3>Weekly Plan</h3>
        <table id="planTable">
          <thead>
            <tr>
              <th>Week</th>
              <th>Date Range</th>
              <th>Planned Weight (lbs)</th>
              <th>Actual Weight (lbs)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table rows will be generated dynamically -->
          </tbody>
        </table>
        <h3>Progress Graph</h3>
        <div id="graphContainer"></div>
      </div>
    </section>
  </div>
  
  <script>
    // Set the minimum date for the startDate input to tomorrow
    function setMinStartDate() {
      const startDateInput = document.getElementById("startDate");
      const today = new Date();
      today.setDate(today.getDate() + 1);
      startDateInput.min = today.toISOString().split("T")[0];
    }
    setMinStartDate();
    
    // Cookie helper functions
    function setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + (exdays*24*60*60*1000));
      const expires = "expires=" + d.toUTCString();
      document.cookie = cname + "=" + encodeURIComponent(cvalue) + ";" + expires + ";path=/";
    }
    
    function getCookie(cname) {
      const name = cname + "=";
      const decodedCookie = decodeURIComponent(document.cookie);
      const ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(name) === 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }
    
    let planData = null;
    
    // Real-time weight validation
    function validateWeights() {
      const currentWeight = parseFloat(document.getElementById("currentWeight").value);
      const targetWeight = parseFloat(document.getElementById("targetWeight").value);
      const warningDiv = document.getElementById("warningMessage");
      warningDiv.innerHTML = "";
      if (!isNaN(currentWeight) && !isNaN(targetWeight)) {
        const maxLoss = currentWeight * 0.12;
        if ((currentWeight - targetWeight) > maxLoss) {
          warningDiv.innerHTML = `<div class="warning">⚠️ Target exceeds recommended 12% weight loss (max ${maxLoss.toFixed(1)} lbs)</div>`;
          document.getElementById("targetWeight").style.border = "2px solid #e74c3c";
        } else {
          document.getElementById("targetWeight").style.border = "";
        }
      }
    }
    document.getElementById("currentWeight").addEventListener("input", validateWeights);
    document.getElementById("targetWeight").addEventListener("input", validateWeights);
    
    // Helper functions for date manipulation
    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }
    
    function formatDate(date) {
      const mm = ("0" + (date.getMonth() + 1)).slice(-2);
      const dd = ("0" + date.getDate()).slice(-2);
      return mm + "/" + dd;
    }
    
    // Generate the 12-week plan (dates and planned weights)
    function generateWeeklyPlan(startDate, currentWeight, targetWeight) {
      const weeks = [];
      const totalLoss = currentWeight - targetWeight;
      let sumFactor = 0;
      for (let i = 1; i <= 12; i++) {
        sumFactor += Math.pow(0.93, i);
      }
      const baseRate = totalLoss / sumFactor;
      let cumulativeLoss = 0;
      for (let i = 0; i < 12; i++) {
        const weekNumber = i + 1;
        const weekStart = addDays(startDate, i * 7);
        const weekEnd = addDays(weekStart, 6);
        const weeklyLoss = baseRate * Math.pow(0.93, weekNumber);
        cumulativeLoss += weeklyLoss;
        let plannedWeight = currentWeight - cumulativeLoss;
        if (plannedWeight < targetWeight) plannedWeight = targetWeight;
        plannedWeight = parseFloat(plannedWeight.toFixed(1));
        weeks.push({
          week: weekNumber,
          start: formatDate(weekStart),
          end: formatDate(weekEnd),
          planned: plannedWeight,
          actual: "" // will hold actual weight (number or empty string)
        });
      }
      return weeks;
    }
    
    // Save the plan when the Save Plan button is pressed
    function savePlan() {
      const startDateStr = document.getElementById("startDate").value;
      const currentWeight = parseFloat(document.getElementById("currentWeight").value);
      const targetWeight = parseFloat(document.getElementById("targetWeight").value);
      
      if (!startDateStr) {
        alert("Please select a start date.");
        document.getElementById("startDate").focus();
        return;
      }
      if (isNaN(currentWeight) || currentWeight < 100) {
        alert("Please enter a valid current weight (min 100).");
        document.getElementById("currentWeight").focus();
        return;
      }
      if (isNaN(targetWeight) || targetWeight < 50) {
        alert("Please enter a valid target weight (min 50).");
        document.getElementById("targetWeight").focus();
        return;
      }
      
      validateWeights();
      
      // Show loading animation
      const btn = document.getElementById("savePlanBtn");
      const spinner = document.getElementById("spinner");
      spinner.style.display = "inline-block";
      btn.disabled = true;
      
      setTimeout(() => {
        spinner.style.display = "none";
        btn.disabled = false;
        const startDate = new Date(startDateStr);
        const weeks = generateWeeklyPlan(startDate, currentWeight, targetWeight);
        planData = {
          startDate: startDateStr,
          startWeight: currentWeight,
          targetWeight: targetWeight,
          weeks: weeks
        };
        setCookie("weightPlan", JSON.stringify(planData), 45);
        console.log("Saved Weight Plan:", planData);
        displayPlan();
      }, 1000);
    }
    
    // Display the weekly plan table and generate the graph
    function displayPlan() {
      document.getElementById("planDisplay").style.display = "block";
      const tbody = document.getElementById("planTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      
      planData.weeks.forEach((week, index) => {
        const row = document.createElement("tr");
        
        // Week number
        const cellWeek = document.createElement("td");
        cellWeek.innerText = week.week;
        row.appendChild(cellWeek);
        
        // Date Range
        const cellRange = document.createElement("td");
        cellRange.innerText = `Week ${week.week}: ${week.start} - ${week.end}`;
        row.appendChild(cellRange);
        
        // Planned Weight
        const cellPlanned = document.createElement("td");
        cellPlanned.innerText = week.planned;
        row.appendChild(cellPlanned);
        
        // Actual Weight (input)
        const cellActual = document.createElement("td");
        const inputActual = document.createElement("input");
        inputActual.type = "number";
        inputActual.min = "0";
        inputActual.value = week.actual;
        inputActual.style.width = "80px";
        inputActual.onchange = function() {
          let val = parseFloat(inputActual.value);
          if (isNaN(val)) {
            planData.weeks[index].actual = "";
          } else {
            planData.weeks[index].actual = val;
          }
          setCookie("weightPlan", JSON.stringify(planData), 45);
          updateGraph();
        };
        cellActual.appendChild(inputActual);
        row.appendChild(cellActual);
        
        tbody.appendChild(row);
      });
      
      updateGraph();
    }
    
    // Generate a simple line graph using inline SVG (no external libraries)
    // This now plots both the planned progression (blue) and actual progress (orange)
    function updateGraph() {
      const container = document.getElementById("graphContainer");
      container.innerHTML = "";
      const width = container.clientWidth;
      const height = container.clientHeight;
      const padding = 40;
      
      const maxWeight = planData.startWeight;
      const minWeight = planData.targetWeight;
      const scaleY = (height - 2 * padding) / (maxWeight - minWeight);
      const xSpacing = (width - 2 * padding) / (planData.weeks.length - 1);
      
      const svgns = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgns, "svg");
      svg.setAttribute("width", width);
      svg.setAttribute("height", height);
      
      // Draw horizontal lines for current and target weights
      function drawHLine(weight, color, label) {
        const y = padding + (maxWeight - weight) * scaleY;
        const line = document.createElementNS(svgns, "line");
        line.setAttribute("x1", padding);
        line.setAttribute("y1", y);
        line.setAttribute("x2", width - padding);
        line.setAttribute("y2", y);
        line.setAttribute("stroke", color);
        line.setAttribute("stroke-dasharray", "4,2");
        svg.appendChild(line);
        
        const text = document.createElementNS(svgns, "text");
        text.setAttribute("x", width - padding);
        text.setAttribute("y", y - 5);
        text.setAttribute("text-anchor", "end");
        text.setAttribute("fill", color);
        text.setAttribute("font-size", "12");
        text.textContent = label + " (" + weight + " lbs)";
        svg.appendChild(text);
      }
      drawHLine(planData.startWeight, "green", "Current Weight");
      drawHLine(planData.targetWeight, "red", "Target Weight");
      
      // Build points for the planned weight line
      let plannedPoints = "";
      planData.weeks.forEach((week, i) => {
        const x = padding + i * xSpacing;
        const y = padding + (maxWeight - week.planned) * scaleY;
        plannedPoints += `${x},${y} `;
        // Draw a circle at each planned data point
        const circle = document.createElementNS(svgns, "circle");
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", 4);
        circle.setAttribute("fill", "blue");
        svg.appendChild(circle);
      });
      
      // Draw polyline connecting the planned weight points
      const polylinePlanned = document.createElementNS(svgns, "polyline");
      polylinePlanned.setAttribute("points", plannedPoints.trim());
      polylinePlanned.setAttribute("fill", "none");
      polylinePlanned.setAttribute("stroke", "blue");
      polylinePlanned.setAttribute("stroke-width", "2");
      svg.appendChild(polylinePlanned);
      
      // Build points for the actual weight line (if any)
      let actualPoints = "";
      let hasActual = false;
      planData.weeks.forEach((week, i) => {
        const x = padding + i * xSpacing;
        if (week.actual !== "" && !isNaN(week.actual)) {
          hasActual = true;
          const actualValue = parseFloat(week.actual);
          const y = padding + (maxWeight - actualValue) * scaleY;
          actualPoints += `${x},${y} `;
          // Draw a circle at each actual data point
          const circle = document.createElementNS(svgns, "circle");
          circle.setAttribute("cx", x);
          circle.setAttribute("cy", y);
          circle.setAttribute("r", 4);
          circle.setAttribute("fill", "orange");
          svg.appendChild(circle);
        }
      });
      if(hasActual && actualPoints.trim() !== "") {
        const polylineActual = document.createElementNS(svgns, "polyline");
        polylineActual.setAttribute("points", actualPoints.trim());
        polylineActual.setAttribute("fill", "none");
        polylineActual.setAttribute("stroke", "orange");
        polylineActual.setAttribute("stroke-width", "2");
        svg.appendChild(polylineActual);
      }
      
      container.appendChild(svg);
    }
    
    // On page load, restore saved plan from cookie (if available)
    function loadPlan() {
      const saved = getCookie("weightPlan");
      if (saved) {
        planData = JSON.parse(saved);
        document.getElementById("startDate").value = planData.startDate;
        document.getElementById("currentWeight").value = planData.startWeight;
        document.getElementById("targetWeight").value = planData.targetWeight;
        displayPlan();
      }
    }
    window.onload = loadPlan;
  </script>
</body>
</html>
